{"ast":null,"code":"import * as d3 from \"d3\";\nimport moment from 'moment';\nimport colors from './colors';\nimport { filter } from './App';\nimport mapboxgl from '!mapbox-gl'; // eslint-disable-line import/no-webpack-loader-syntax\n\nimport 'mapbox-gl/dist/mapbox-gl.css';\nimport { addCommas } from './HelperFunctions';\nmapboxgl.accessToken = 'pk.eyJ1IjoiZ28taWZyYyIsImEiOiJjams3b2ZhZWswMGFvM3hxeHp2ZHFhOTRrIn0._pqO9OQ2iNeDGrpopJNjpg';\nlet map;\nexport function createMap(data, options, filter) {\n  console.log('createMap');\n  map = new mapboxgl.Map({\n    container: 'map_div',\n    // container ID\n    style: 'mapbox://styles/go-ifrc/ck9tz6f150ub11ip8j97wrsww',\n    // style URL\n    center: [8, 22],\n    // starting position [lng, lat]\n    zoom: -0.01 // starting zoom\n\n  });\n  map.setRenderWorldCopies(false);\n  map.addControl(new mapboxgl.NavigationControl());\n  var container = map.getCanvasContainer();\n  var svg = d3.select(container).append(\"svg\").attr('id', 'mapoverlay').attr(\"width\", \"100%\").attr(\"height\", \"24vw\").style(\"position\", \"absolute\").style(\"z-index\", 2); // svg.on('mousemove', function(event){\n  //     console.log(event);\n  // })\n\n  var dots = svg.selectAll(\".country-map\").data(data.world).enter().append(\"circle\").attr('class', 'country-map').attr('id', function (d, i) {\n    return 'country-map-' + d.iso2;\n  }).attr(\"r\", 0);\n  var maxValue = d3.max(data.country, function (d, i) {\n    return d[1].cumulative_cases;\n  });\n  var rScale = d3.scalePow().exponent(0.5).domain([0, maxValue]).range([0, 15]);\n  data.country.forEach(function (d, i) {\n    d3.select('#country-' + d[0]).attr('r', rScale(d[1].cumulative_cases)).attr('data-name', d[1].country);\n  });\n  document.getElementById(\"mapoverlay\").appendChild(d3.select('#map_tooltip').node());\n\n  function render() {\n    dots.attr(\"cx\", function (d) {\n      return project([d.lng, d.lat]).x;\n    }).attr(\"cy\", function (d) {\n      return project([d.lng, d.lat]).y;\n    });\n  }\n\n  map.on(\"viewreset\", render);\n  map.on(\"move\", render);\n  map.on(\"moveend\", render);\n  render(); // Call once to render\n  // map.on('mousemove', function (e) {\n  //     var features = map.queryRenderedFeatures(e.point);\n  //     var displayProperties = [\n  //     'type',\n  //     'properties',\n  //     'id',\n  //     'layer',\n  //     'source',\n  //     'sourceLayer',\n  //     'state'\n  //     ];\n  //     var displayFeatures = features.map(function (feat) {\n  //     var displayFeat = {};\n  //     displayProperties.forEach(function (prop) {\n  //     displayFeat[prop] = feat[prop];\n  //     });\n  //     return displayFeat;\n  //     });\n  //     console.log(JSON.stringify(\n  //     displayFeatures,\n  //     null,\n  //     2\n  //     ))\n  //     })\n\n  updateMap(data, options);\n}\nexport function updateMap(data, options) {\n  var duration = 1000;\n  var delay = 10;\n\n  if (options.map_toggle == 'bi-weekly-change') {\n    var maxValue = d3.max(data.country, function (d, i) {\n      return d[1].percent_change;\n    });\n    console.log(maxValue);\n    var rScale = d3.scalePow().exponent(0.5).domain([-1, 0, 1]).range([20, 0, 20]).clamp(true);\n    d3.selectAll('.country-map').transition('c').duration(duration / 1.7).attr('r', 0);\n    data.country.forEach(function (d, i) {\n      d3.select('#country-map-' + d[0]).transition('c').duration(duration).delay(delay).attr('r', rScale(d[1].percent_change)).style('stroke', function () {\n        // if(d[1].percent_change>1){ return '#E02225'} else { return '#1F558C'}\n        return '#FFF';\n      }).style('fill', function () {\n        if (d[1].percent_change > 0) {\n          return '#E02225';\n        } else {\n          return '#1F558C';\n        }\n      });\n    });\n  }\n\n  if (options.map_toggle == 'cases') {\n    var maxValue = d3.max(data.country, function (d, i) {\n      return d[1].cumulative_cases;\n    });\n    var rScale = d3.scalePow().exponent(0.5).domain([0, maxValue]).range([0, 20]);\n    d3.selectAll('.country-map').transition('c').duration(duration / 1.7).attr('r', 0);\n    data.country.forEach(function (d, i) {\n      d3.select('#country-map-' + d[0]).transition('c').duration(duration).delay(delay).attr('r', rScale(d[1].cumulative_cases)).style('fill', '#E02225').style('stroke', '#FFF');\n    });\n  }\n\n  if (options.map_toggle == 'deaths') {\n    var maxValue = d3.max(data.country, function (d, i) {\n      return d[1].cumulative_deaths;\n    });\n    var rScale = d3.scalePow().exponent(0.5).domain([0, maxValue]).range([0, 20]);\n    d3.selectAll('.country-map').transition('c').duration(duration / 1.7).attr('r', 0);\n    data.country.forEach(function (d, i) {\n      d3.select('#country-map-' + d[0]).transition('c').duration(duration).delay(delay).attr('r', rScale(d[1].cumulative_deaths)).style('fill', '#E02225').style('stroke', '#FFF');\n    });\n  }\n\n  if (options.map_toggle == 'percent-fully-vaccinated') {\n    var maxValue = d3.max(data.vGroup, function (d, i) {\n      return parseFloat(d[1][0].people_fully_vaccinated_per_hundred) / 100;\n    });\n    var rScale = d3.scalePow().exponent(0.5).domain([0, 1]).range([0, 20]).clamp(true);\n    d3.selectAll('.country-map').transition('c').duration(duration / 1.7).attr('r', 0);\n    data.vGroup.forEach(function (d, i) {\n      var peoplevaccinated = parseFloat(d[1][0].people_fully_vaccinated_per_hundred) / 100;\n      if (isNaN(peoplevaccinated)) peoplevaccinated = 0;\n      d3.select('#country-map-' + d[1][0].country_code).transition('c').duration(duration).delay(delay).attr('r', rScale(peoplevaccinated)).style('stroke', '#FFF').style('fill', function () {\n        if (peoplevaccinated <= 1) {\n          return '#E02225';\n        } else {\n          return '#1F558C';\n        }\n      });\n    });\n  }\n\n  if (options.map_toggle == 'percent-vaccine-acceptance') {// var maxValue = d3.max(data.country, function(d,i){\n    //     return d[1].cumulative_deaths;\n    // })\n    // var rScale = d3.scalePow().exponent(0.5)\n    // .domain([0, maxValue])\n    // .range([0, 20]);\n    // d3.selectAll('.country-map').transition('c').duration(duration/1.7).attr('r',0);\n    // data.country.forEach(function(d,i){\n    //     d3.select('#country-map-'+d[0])\n    //     .transition('c').duration(duration).delay(delay)\n    //     .attr('r', rScale(d[1].cumulative_deaths))\n    //     .style('fill', '#E02225')\n    //     .style('stroke', '#FFF');\n    // })\n  } // tooltips\n\n\n  var mapTooltip = d3.select('#map_tooltip').attr('opacity', 1).attr('transform', 'translate(0,0)').attr('display', 'none');\n  d3.selectAll('.country-map').on('mousemove', function (event, d) {\n    // console.log(data);\n    // console.log(data.equity_data);\n    console.log(options.map_toggle);\n    var id = d3.select(this).attr('id').substr(12, 2);\n    console.log(id);\n    var countryName = data.equity_data.filter(d => d.country_iso2 == id)[0].country_name;\n    mapTooltip.select('#map_tooltip_name tspan').text(countryName);\n\n    if (options.map_toggle == 'cases') {\n      var country = data.country.filter(d => d[1].country_code == id)[0];\n      if (country.length == 0) return false;\n      console.log(country);\n      mapTooltip.select('#map_tooltip_val tspan').text(addCommas(country[1].cumulative_cases) + ' cases');\n    }\n\n    if (options.map_toggle == 'deaths') {\n      var country = data.country.filter(d => d[1].country_code == id)[0];\n      if (country.length == 0) return false;\n      console.log(country);\n      mapTooltip.select('#map_tooltip_val tspan').text(addCommas(country[1].cumulative_deaths) + ' deaths');\n    }\n\n    if (options.map_toggle == 'bi-weekly-change') {\n      var country = data.country.filter(d => d[1].country_code == id)[0];\n      if (country.length == 0) return false;\n      console.log(country);\n      var val = (country[1].percent_change * 100).toFixed(1);\n      var str = '';\n\n      if (val >= 0) {\n        str = '% increase';\n      } else {\n        str = '% decrease';\n      }\n\n      mapTooltip.select('#map_tooltip_val tspan').text(Math.abs(val) + str);\n    }\n\n    if (options.map_toggle == 'percent-fully-vaccinated') {\n      var country = data.vGroup.filter(d => d[1].country_code == id)[0];\n      console.log(country);\n      if (country.length == 0) return false;\n      console.log(country);\n      mapTooltip.select('#map_tooltip_val tspan').text(addCommas(country[1].cumulative_deaths) + ' deaths');\n    }\n\n    var scale = window.innerWidth / 1329;\n    mapTooltip.attr('display', 'inline').attr('transform', 'translate(' + project([d.lng, d.lat]).x + ',' + project([d.lng, d.lat]).y + ')scale(' + scale + ')');\n    var heightOffset = mapTooltip.node().getBBox();\n    mapTooltip.attr('transform', 'translate(' + (project([d.lng, d.lat]).x + 3) + ',' + (project([d.lng, d.lat]).y + 2 - heightOffset.height / 2) + ')scale(' + scale + ')');\n  }).on('mouseout', function (event) {\n    console.log(event);\n    if (event.toElement == 'tspan') return false;\n    mapTooltip.attr('display', 'none');\n  });\n}\n\nfunction project(d) {\n  return map.project(new mapboxgl.LngLat(d[0], d[1]));\n}\n\nexport default createMap;","map":{"version":3,"sources":["/Users/matthewsmawfield/www/ifrc-covid-dataviz/src/Map.js"],"names":["d3","moment","colors","filter","mapboxgl","addCommas","accessToken","map","createMap","data","options","console","log","Map","container","style","center","zoom","setRenderWorldCopies","addControl","NavigationControl","getCanvasContainer","svg","select","append","attr","dots","selectAll","world","enter","d","i","iso2","maxValue","max","country","cumulative_cases","rScale","scalePow","exponent","domain","range","forEach","document","getElementById","appendChild","node","render","project","lng","lat","x","y","on","updateMap","duration","delay","map_toggle","percent_change","clamp","transition","cumulative_deaths","vGroup","parseFloat","people_fully_vaccinated_per_hundred","peoplevaccinated","isNaN","country_code","mapTooltip","event","id","substr","countryName","equity_data","country_iso2","country_name","text","length","val","toFixed","str","Math","abs","scale","window","innerWidth","heightOffset","getBBox","height","toElement","LngLat"],"mappings":"AAAA,OAAO,KAAKA,EAAZ,MAAoB,IAApB;AACA,OAAOC,MAAP,MAAmB,QAAnB;AACA,OAAOC,MAAP,MAAmB,UAAnB;AACA,SAAQC,MAAR,QAAqB,OAArB;AACA,OAAOC,QAAP,MAAqB,YAArB,C,CAAmC;;AACnC,OAAO,8BAAP;AACA,SAAQC,SAAR,QAAwB,mBAAxB;AAEAD,QAAQ,CAACE,WAAT,GAAuB,2FAAvB;AAEA,IAAIC,GAAJ;AACA,OAAO,SAASC,SAAT,CAAmBC,IAAnB,EAAyBC,OAAzB,EAAkCP,MAAlC,EAA0C;AAC7CQ,EAAAA,OAAO,CAACC,GAAR,CAAY,WAAZ;AAEAL,EAAAA,GAAG,GAAG,IAAIH,QAAQ,CAACS,GAAb,CAAiB;AACnBC,IAAAA,SAAS,EAAE,SADQ;AACG;AACtBC,IAAAA,KAAK,EAAE,mDAFY;AAEyC;AAC5DC,IAAAA,MAAM,EAAE,CAAC,CAAD,EAAI,EAAJ,CAHW;AAGF;AACjBC,IAAAA,IAAI,EAAE,CAAC,IAJY,CAIP;;AAJO,GAAjB,CAAN;AAOAV,EAAAA,GAAG,CAACW,oBAAJ,CAAyB,KAAzB;AACAX,EAAAA,GAAG,CAACY,UAAJ,CAAe,IAAIf,QAAQ,CAACgB,iBAAb,EAAf;AAEA,MAAIN,SAAS,GAAGP,GAAG,CAACc,kBAAJ,EAAhB;AAEA,MAAIC,GAAG,GAAGtB,EAAE,CACXuB,MADS,CACFT,SADE,EAETU,MAFS,CAEF,KAFE,EAGTC,IAHS,CAGJ,IAHI,EAGE,YAHF,EAITA,IAJS,CAIJ,OAJI,EAIK,MAJL,EAKTA,IALS,CAKJ,QALI,EAKM,MALN,EAMTV,KANS,CAMH,UANG,EAMS,UANT,EAOTA,KAPS,CAOH,SAPG,EAOQ,CAPR,CAAV,CAf6C,CAwB7C;AACA;AACA;;AAEA,MAAIW,IAAI,GAAGJ,GAAG,CACbK,SADU,CACA,cADA,EAEVlB,IAFU,CAELA,IAAI,CAACmB,KAFA,EAGVC,KAHU,GAIVL,MAJU,CAIH,QAJG,EAKVC,IALU,CAKL,OALK,EAKI,aALJ,EAMVA,IANU,CAML,IANK,EAMC,UAASK,CAAT,EAAWC,CAAX,EAAa;AAAE,WAAO,iBAAeD,CAAC,CAACE,IAAxB;AAA8B,GAN9C,EAOVP,IAPU,CAOL,GAPK,EAOA,CAPA,CAAX;AAUA,MAAIQ,QAAQ,GAAGjC,EAAE,CAACkC,GAAH,CAAOzB,IAAI,CAAC0B,OAAZ,EAAqB,UAASL,CAAT,EAAWC,CAAX,EAAa;AAC7C,WAAOD,CAAC,CAAC,CAAD,CAAD,CAAKM,gBAAZ;AACH,GAFc,CAAf;AAIA,MAAIC,MAAM,GAAGrC,EAAE,CAACsC,QAAH,GAAcC,QAAd,CAAuB,GAAvB,EACVC,MADU,CACH,CAAC,CAAD,EAAIP,QAAJ,CADG,EAEVQ,KAFU,CAEJ,CAAC,CAAD,EAAI,EAAJ,CAFI,CAAb;AAIAhC,EAAAA,IAAI,CAAC0B,OAAL,CAAaO,OAAb,CAAqB,UAASZ,CAAT,EAAWC,CAAX,EAAa;AAC9B/B,IAAAA,EAAE,CAACuB,MAAH,CAAU,cAAYO,CAAC,CAAC,CAAD,CAAvB,EAA4BL,IAA5B,CAAiC,GAAjC,EAAsCY,MAAM,CAACP,CAAC,CAAC,CAAD,CAAD,CAAKM,gBAAN,CAA5C,EACCX,IADD,CACM,WADN,EACmBK,CAAC,CAAC,CAAD,CAAD,CAAKK,OADxB;AAEH,GAHD;AAKAQ,EAAAA,QAAQ,CAACC,cAAT,CAAwB,YAAxB,EAAsCC,WAAtC,CAAkD7C,EAAE,CAACuB,MAAH,CAAU,cAAV,EAA0BuB,IAA1B,EAAlD;;AAGA,WAASC,MAAT,GAAkB;AACdrB,IAAAA,IAAI,CACDD,IADH,CACQ,IADR,EACc,UAASK,CAAT,EAAY;AACtB,aAAOkB,OAAO,CAAE,CAAClB,CAAC,CAACmB,GAAH,EAAQnB,CAAC,CAACoB,GAAV,CAAF,CAAP,CAA0BC,CAAjC;AACD,KAHH,EAIG1B,IAJH,CAIQ,IAJR,EAIc,UAASK,CAAT,EAAY;AACtB,aAAOkB,OAAO,CAAE,CAAClB,CAAC,CAACmB,GAAH,EAAQnB,CAAC,CAACoB,GAAV,CAAF,CAAP,CAA0BE,CAAjC;AACD,KANH;AAOD;;AAEH7C,EAAAA,GAAG,CAAC8C,EAAJ,CAAO,WAAP,EAAoBN,MAApB;AACAxC,EAAAA,GAAG,CAAC8C,EAAJ,CAAO,MAAP,EAAeN,MAAf;AACAxC,EAAAA,GAAG,CAAC8C,EAAJ,CAAO,SAAP,EAAkBN,MAAlB;AACAA,EAAAA,MAAM,GAnEuC,CAmEnC;AAEV;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;;AACAO,EAAAA,SAAS,CAAC7C,IAAD,EAAOC,OAAP,CAAT;AACH;AAED,OAAO,SAAS4C,SAAT,CAAmB7C,IAAnB,EAAyBC,OAAzB,EAAkC;AAErC,MAAI6C,QAAQ,GAAG,IAAf;AACA,MAAIC,KAAK,GAAG,EAAZ;;AAGA,MAAG9C,OAAO,CAAC+C,UAAR,IAAsB,kBAAzB,EAA4C;AAExC,QAAIxB,QAAQ,GAAGjC,EAAE,CAACkC,GAAH,CAAOzB,IAAI,CAAC0B,OAAZ,EAAqB,UAASL,CAAT,EAAWC,CAAX,EAAa;AAC7C,aAAOD,CAAC,CAAC,CAAD,CAAD,CAAK4B,cAAZ;AACH,KAFc,CAAf;AAIA/C,IAAAA,OAAO,CAACC,GAAR,CAAYqB,QAAZ;AAEA,QAAII,MAAM,GAAGrC,EAAE,CAACsC,QAAH,GAAcC,QAAd,CAAuB,GAAvB,EACZC,MADY,CACL,CAAC,CAAC,CAAF,EAAK,CAAL,EAAQ,CAAR,CADK,EAEZC,KAFY,CAEN,CAAC,EAAD,EAAK,CAAL,EAAQ,EAAR,CAFM,EAGZkB,KAHY,CAGN,IAHM,CAAb;AAKA3D,IAAAA,EAAE,CAAC2B,SAAH,CAAa,cAAb,EAA6BiC,UAA7B,CAAwC,GAAxC,EAA6CL,QAA7C,CAAsDA,QAAQ,GAAC,GAA/D,EAAoE9B,IAApE,CAAyE,GAAzE,EAA6E,CAA7E;AAEAhB,IAAAA,IAAI,CAAC0B,OAAL,CAAaO,OAAb,CAAqB,UAASZ,CAAT,EAAWC,CAAX,EAAa;AAC9B/B,MAAAA,EAAE,CAACuB,MAAH,CAAU,kBAAgBO,CAAC,CAAC,CAAD,CAA3B,EACC8B,UADD,CACY,GADZ,EACiBL,QADjB,CAC0BA,QAD1B,EACoCC,KADpC,CAC0CA,KAD1C,EAEC/B,IAFD,CAEM,GAFN,EAEWY,MAAM,CAACP,CAAC,CAAC,CAAD,CAAD,CAAK4B,cAAN,CAFjB,EAGC3C,KAHD,CAGO,QAHP,EAGiB,YAAU;AACvB;AACA,eAAO,MAAP;AACH,OAND,EAMGA,KANH,CAMS,MANT,EAMiB,YAAU;AACvB,YAAGe,CAAC,CAAC,CAAD,CAAD,CAAK4B,cAAL,GAAoB,CAAvB,EAAyB;AAAE,iBAAO,SAAP;AAAiB,SAA5C,MAAkD;AAAE,iBAAO,SAAP;AAAiB;AACxE,OARD;AASH,KAVD;AAYH;;AAED,MAAGhD,OAAO,CAAC+C,UAAR,IAAsB,OAAzB,EAAiC;AAC7B,QAAIxB,QAAQ,GAAGjC,EAAE,CAACkC,GAAH,CAAOzB,IAAI,CAAC0B,OAAZ,EAAqB,UAASL,CAAT,EAAWC,CAAX,EAAa;AAC7C,aAAOD,CAAC,CAAC,CAAD,CAAD,CAAKM,gBAAZ;AACH,KAFc,CAAf;AAIA,QAAIC,MAAM,GAAGrC,EAAE,CAACsC,QAAH,GAAcC,QAAd,CAAuB,GAAvB,EACZC,MADY,CACL,CAAC,CAAD,EAAIP,QAAJ,CADK,EAEZQ,KAFY,CAEN,CAAC,CAAD,EAAI,EAAJ,CAFM,CAAb;AAIAzC,IAAAA,EAAE,CAAC2B,SAAH,CAAa,cAAb,EAA6BiC,UAA7B,CAAwC,GAAxC,EAA6CL,QAA7C,CAAsDA,QAAQ,GAAC,GAA/D,EAAoE9B,IAApE,CAAyE,GAAzE,EAA6E,CAA7E;AAEAhB,IAAAA,IAAI,CAAC0B,OAAL,CAAaO,OAAb,CAAqB,UAASZ,CAAT,EAAWC,CAAX,EAAa;AAC9B/B,MAAAA,EAAE,CAACuB,MAAH,CAAU,kBAAgBO,CAAC,CAAC,CAAD,CAA3B,EACC8B,UADD,CACY,GADZ,EACiBL,QADjB,CAC0BA,QAD1B,EACoCC,KADpC,CAC0CA,KAD1C,EAEC/B,IAFD,CAEM,GAFN,EAEWY,MAAM,CAACP,CAAC,CAAC,CAAD,CAAD,CAAKM,gBAAN,CAFjB,EAGCrB,KAHD,CAGO,MAHP,EAGe,SAHf,EAICA,KAJD,CAIO,QAJP,EAIiB,MAJjB;AAKH,KAND;AAQH;;AAED,MAAGL,OAAO,CAAC+C,UAAR,IAAsB,QAAzB,EAAkC;AAC9B,QAAIxB,QAAQ,GAAGjC,EAAE,CAACkC,GAAH,CAAOzB,IAAI,CAAC0B,OAAZ,EAAqB,UAASL,CAAT,EAAWC,CAAX,EAAa;AAC7C,aAAOD,CAAC,CAAC,CAAD,CAAD,CAAK+B,iBAAZ;AACH,KAFc,CAAf;AAIA,QAAIxB,MAAM,GAAGrC,EAAE,CAACsC,QAAH,GAAcC,QAAd,CAAuB,GAAvB,EACZC,MADY,CACL,CAAC,CAAD,EAAIP,QAAJ,CADK,EAEZQ,KAFY,CAEN,CAAC,CAAD,EAAI,EAAJ,CAFM,CAAb;AAIAzC,IAAAA,EAAE,CAAC2B,SAAH,CAAa,cAAb,EAA6BiC,UAA7B,CAAwC,GAAxC,EAA6CL,QAA7C,CAAsDA,QAAQ,GAAC,GAA/D,EAAoE9B,IAApE,CAAyE,GAAzE,EAA6E,CAA7E;AAEAhB,IAAAA,IAAI,CAAC0B,OAAL,CAAaO,OAAb,CAAqB,UAASZ,CAAT,EAAWC,CAAX,EAAa;AAC9B/B,MAAAA,EAAE,CAACuB,MAAH,CAAU,kBAAgBO,CAAC,CAAC,CAAD,CAA3B,EACC8B,UADD,CACY,GADZ,EACiBL,QADjB,CAC0BA,QAD1B,EACoCC,KADpC,CAC0CA,KAD1C,EAEC/B,IAFD,CAEM,GAFN,EAEWY,MAAM,CAACP,CAAC,CAAC,CAAD,CAAD,CAAK+B,iBAAN,CAFjB,EAGC9C,KAHD,CAGO,MAHP,EAGe,SAHf,EAICA,KAJD,CAIO,QAJP,EAIiB,MAJjB;AAKH,KAND;AAQH;;AAED,MAAGL,OAAO,CAAC+C,UAAR,IAAsB,0BAAzB,EAAoD;AAChD,QAAIxB,QAAQ,GAAGjC,EAAE,CAACkC,GAAH,CAAOzB,IAAI,CAACqD,MAAZ,EAAoB,UAAShC,CAAT,EAAWC,CAAX,EAAa;AAC5C,aAAOgC,UAAU,CAACjC,CAAC,CAAC,CAAD,CAAD,CAAK,CAAL,EAAQkC,mCAAT,CAAV,GAAwD,GAA/D;AACH,KAFc,CAAf;AAIA,QAAI3B,MAAM,GAAGrC,EAAE,CAACsC,QAAH,GAAcC,QAAd,CAAuB,GAAvB,EACZC,MADY,CACL,CAAC,CAAD,EAAI,CAAJ,CADK,EAEZC,KAFY,CAEN,CAAC,CAAD,EAAI,EAAJ,CAFM,EAGZkB,KAHY,CAGN,IAHM,CAAb;AAKA3D,IAAAA,EAAE,CAAC2B,SAAH,CAAa,cAAb,EAA6BiC,UAA7B,CAAwC,GAAxC,EAA6CL,QAA7C,CAAsDA,QAAQ,GAAC,GAA/D,EAAoE9B,IAApE,CAAyE,GAAzE,EAA6E,CAA7E;AAEAhB,IAAAA,IAAI,CAACqD,MAAL,CAAYpB,OAAZ,CAAoB,UAASZ,CAAT,EAAWC,CAAX,EAAa;AAC7B,UAAIkC,gBAAgB,GAAGF,UAAU,CAACjC,CAAC,CAAC,CAAD,CAAD,CAAK,CAAL,EAAQkC,mCAAT,CAAV,GAAwD,GAA/E;AACA,UAAGE,KAAK,CAACD,gBAAD,CAAR,EAA4BA,gBAAgB,GAAG,CAAnB;AAC5BjE,MAAAA,EAAE,CAACuB,MAAH,CAAU,kBAAgBO,CAAC,CAAC,CAAD,CAAD,CAAK,CAAL,EAAQqC,YAAlC,EACCP,UADD,CACY,GADZ,EACiBL,QADjB,CAC0BA,QAD1B,EACoCC,KADpC,CAC0CA,KAD1C,EAEC/B,IAFD,CAEM,GAFN,EAEWY,MAAM,CAAC4B,gBAAD,CAFjB,EAGClD,KAHD,CAGO,QAHP,EAGiB,MAHjB,EAICA,KAJD,CAIO,MAJP,EAIe,YAAU;AACrB,YAAGkD,gBAAgB,IAAE,CAArB,EAAuB;AAAE,iBAAO,SAAP;AAAiB,SAA1C,MAAgD;AAAE,iBAAO,SAAP;AAAiB;AACtE,OAND;AAOH,KAVD;AAaH;;AAED,MAAGvD,OAAO,CAAC+C,UAAR,IAAsB,4BAAzB,EAAsD,CAClD;AACA;AACA;AAEA;AACA;AACA;AAEA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AAEH,GA3HoC,CA6HrC;;;AAEA,MAAIW,UAAU,GAAGpE,EAAE,CAACuB,MAAH,CAAU,cAAV,EAA0BE,IAA1B,CAA+B,SAA/B,EAA0C,CAA1C,EAA6CA,IAA7C,CAAkD,WAAlD,EAA+D,gBAA/D,EAAiFA,IAAjF,CAAsF,SAAtF,EAAiG,MAAjG,CAAjB;AAEAzB,EAAAA,EAAE,CAAC2B,SAAH,CAAa,cAAb,EAA6B0B,EAA7B,CAAgC,WAAhC,EAA6C,UAASgB,KAAT,EAAgBvC,CAAhB,EAAkB;AAC3D;AACA;AACAnB,IAAAA,OAAO,CAACC,GAAR,CAAYF,OAAO,CAAC+C,UAApB;AAEA,QAAIa,EAAE,GAAGtE,EAAE,CAACuB,MAAH,CAAU,IAAV,EAAgBE,IAAhB,CAAqB,IAArB,EAA2B8C,MAA3B,CAAkC,EAAlC,EAAqC,CAArC,CAAT;AACA5D,IAAAA,OAAO,CAACC,GAAR,CAAY0D,EAAZ;AACA,QAAIE,WAAW,GAAG/D,IAAI,CAACgE,WAAL,CAAiBtE,MAAjB,CAAwB2B,CAAC,IAAEA,CAAC,CAAC4C,YAAF,IAAkBJ,EAA7C,EAAiD,CAAjD,EAAoDK,YAAtE;AACAP,IAAAA,UAAU,CAAC7C,MAAX,CAAkB,yBAAlB,EAA6CqD,IAA7C,CAAkDJ,WAAlD;;AAEA,QAAG9D,OAAO,CAAC+C,UAAR,IAAoB,OAAvB,EAA+B;AAC3B,UAAItB,OAAO,GAAG1B,IAAI,CAAC0B,OAAL,CAAahC,MAAb,CAAoB2B,CAAC,IAAEA,CAAC,CAAC,CAAD,CAAD,CAAKqC,YAAL,IAAqBG,EAA5C,EAAgD,CAAhD,CAAd;AACA,UAAGnC,OAAO,CAAC0C,MAAR,IAAgB,CAAnB,EAAsB,OAAO,KAAP;AACtBlE,MAAAA,OAAO,CAACC,GAAR,CAAYuB,OAAZ;AACAiC,MAAAA,UAAU,CAAC7C,MAAX,CAAkB,wBAAlB,EAA4CqD,IAA5C,CAAiDvE,SAAS,CAAC8B,OAAO,CAAC,CAAD,CAAP,CAAWC,gBAAZ,CAAT,GAAuC,QAAxF;AACH;;AAED,QAAG1B,OAAO,CAAC+C,UAAR,IAAoB,QAAvB,EAAgC;AAC5B,UAAItB,OAAO,GAAG1B,IAAI,CAAC0B,OAAL,CAAahC,MAAb,CAAoB2B,CAAC,IAAEA,CAAC,CAAC,CAAD,CAAD,CAAKqC,YAAL,IAAqBG,EAA5C,EAAgD,CAAhD,CAAd;AACA,UAAGnC,OAAO,CAAC0C,MAAR,IAAgB,CAAnB,EAAsB,OAAO,KAAP;AACtBlE,MAAAA,OAAO,CAACC,GAAR,CAAYuB,OAAZ;AACAiC,MAAAA,UAAU,CAAC7C,MAAX,CAAkB,wBAAlB,EAA4CqD,IAA5C,CAAiDvE,SAAS,CAAC8B,OAAO,CAAC,CAAD,CAAP,CAAW0B,iBAAZ,CAAT,GAAwC,SAAzF;AACH;;AAED,QAAGnD,OAAO,CAAC+C,UAAR,IAAoB,kBAAvB,EAA0C;AACtC,UAAItB,OAAO,GAAG1B,IAAI,CAAC0B,OAAL,CAAahC,MAAb,CAAoB2B,CAAC,IAAEA,CAAC,CAAC,CAAD,CAAD,CAAKqC,YAAL,IAAqBG,EAA5C,EAAgD,CAAhD,CAAd;AACA,UAAGnC,OAAO,CAAC0C,MAAR,IAAgB,CAAnB,EAAsB,OAAO,KAAP;AACtBlE,MAAAA,OAAO,CAACC,GAAR,CAAYuB,OAAZ;AACA,UAAI2C,GAAG,GAAG,CAAE3C,OAAO,CAAC,CAAD,CAAP,CAAWuB,cAAZ,GAA4B,GAA7B,EAAkCqB,OAAlC,CAA0C,CAA1C,CAAV;AACA,UAAIC,GAAG,GAAG,EAAV;;AACA,UAAGF,GAAG,IAAE,CAAR,EAAU;AACNE,QAAAA,GAAG,GAAG,YAAN;AACH,OAFD,MAEO;AACHA,QAAAA,GAAG,GAAG,YAAN;AACH;;AACDZ,MAAAA,UAAU,CAAC7C,MAAX,CAAkB,wBAAlB,EAA4CqD,IAA5C,CAAiDK,IAAI,CAACC,GAAL,CAASJ,GAAT,IAAcE,GAA/D;AACH;;AAED,QAAGtE,OAAO,CAAC+C,UAAR,IAAoB,0BAAvB,EAAkD;AAC9C,UAAItB,OAAO,GAAG1B,IAAI,CAACqD,MAAL,CAAY3D,MAAZ,CAAmB2B,CAAC,IAAEA,CAAC,CAAC,CAAD,CAAD,CAAKqC,YAAL,IAAqBG,EAA3C,EAA+C,CAA/C,CAAd;AACA3D,MAAAA,OAAO,CAACC,GAAR,CAAYuB,OAAZ;AACA,UAAGA,OAAO,CAAC0C,MAAR,IAAgB,CAAnB,EAAsB,OAAO,KAAP;AACtBlE,MAAAA,OAAO,CAACC,GAAR,CAAYuB,OAAZ;AACAiC,MAAAA,UAAU,CAAC7C,MAAX,CAAkB,wBAAlB,EAA4CqD,IAA5C,CAAiDvE,SAAS,CAAC8B,OAAO,CAAC,CAAD,CAAP,CAAW0B,iBAAZ,CAAT,GAAwC,SAAzF;AACH;;AAMD,QAAIsB,KAAK,GAAGC,MAAM,CAACC,UAAP,GAAkB,IAA9B;AACAjB,IAAAA,UAAU,CACT3C,IADD,CACM,SADN,EACiB,QADjB,EAECA,IAFD,CAEM,WAFN,EAEmB,eAAauB,OAAO,CAAE,CAAClB,CAAC,CAACmB,GAAH,EAAQnB,CAAC,CAACoB,GAAV,CAAF,CAAP,CAA0BC,CAAvC,GAAyC,GAAzC,GAA6CH,OAAO,CAAE,CAAClB,CAAC,CAACmB,GAAH,EAAQnB,CAAC,CAACoB,GAAV,CAAF,CAAP,CAA0BE,CAAvE,GAAyE,SAAzE,GAAmF+B,KAAnF,GAAyF,GAF5G;AAIA,QAAIG,YAAY,GAAGlB,UAAU,CAACtB,IAAX,GAAkByC,OAAlB,EAAnB;AACAnB,IAAAA,UAAU,CAAC3C,IAAX,CAAgB,WAAhB,EAA6B,gBAAcuB,OAAO,CAAE,CAAClB,CAAC,CAACmB,GAAH,EAAQnB,CAAC,CAACoB,GAAV,CAAF,CAAP,CAA0BC,CAA1B,GAA4B,CAA1C,IAA6C,GAA7C,IAAkDH,OAAO,CAAE,CAAClB,CAAC,CAACmB,GAAH,EAAQnB,CAAC,CAACoB,GAAV,CAAF,CAAP,CAA0BE,CAA1B,GAA4B,CAA5B,GAA8BkC,YAAY,CAACE,MAAb,GAAoB,CAApG,IAAuG,SAAvG,GAAiHL,KAAjH,GAAuH,GAApJ;AAEH,GA1DD,EA0DG9B,EA1DH,CA0DM,UA1DN,EA0DkB,UAASgB,KAAT,EAAe;AAC7B1D,IAAAA,OAAO,CAACC,GAAR,CAAYyD,KAAZ;AACA,QAAGA,KAAK,CAACoB,SAAN,IAAiB,OAApB,EAA6B,OAAO,KAAP;AAC7BrB,IAAAA,UAAU,CAAC3C,IAAX,CAAgB,SAAhB,EAA2B,MAA3B;AACH,GA9DD;AAmEH;;AAED,SAASuB,OAAT,CAAiBlB,CAAjB,EAAoB;AAChB,SAAOvB,GAAG,CAACyC,OAAJ,CAAY,IAAI5C,QAAQ,CAACsF,MAAb,CAAoB5D,CAAC,CAAC,CAAD,CAArB,EAA0BA,CAAC,CAAC,CAAD,CAA3B,CAAZ,CAAP;AACH;;AAGD,eAAetB,SAAf","sourcesContent":["import * as d3 from \"d3\";\nimport moment from 'moment';\nimport colors from './colors';\nimport {filter} from './App';\nimport mapboxgl from '!mapbox-gl'; // eslint-disable-line import/no-webpack-loader-syntax\nimport 'mapbox-gl/dist/mapbox-gl.css';\nimport {addCommas} from './HelperFunctions';\n\nmapboxgl.accessToken = 'pk.eyJ1IjoiZ28taWZyYyIsImEiOiJjams3b2ZhZWswMGFvM3hxeHp2ZHFhOTRrIn0._pqO9OQ2iNeDGrpopJNjpg';\n\nlet map;\nexport function createMap(data, options, filter) {\n    console.log('createMap');\n\n    map = new mapboxgl.Map({\n        container: 'map_div', // container ID\n        style: 'mapbox://styles/go-ifrc/ck9tz6f150ub11ip8j97wrsww', // style URL\n        center: [8, 22], // starting position [lng, lat]\n        zoom: -0.01 // starting zoom\n    });\n\n    map.setRenderWorldCopies(false);\n    map.addControl(new mapboxgl.NavigationControl());\n    \n    var container = map.getCanvasContainer();\n\n    var svg = d3\n    .select(container)\n    .append(\"svg\")\n    .attr('id', 'mapoverlay')\n    .attr(\"width\", \"100%\")\n    .attr(\"height\", \"24vw\")\n    .style(\"position\", \"absolute\")\n    .style(\"z-index\", 2);\n\n    // svg.on('mousemove', function(event){\n    //     console.log(event);\n    // })\n\n    var dots = svg\n    .selectAll(\".country-map\")\n    .data(data.world)\n    .enter()\n    .append(\"circle\")\n    .attr('class', 'country-map')\n    .attr('id', function(d,i){ return 'country-map-'+d.iso2 })\n    .attr(\"r\", 0)\n    \n\n    var maxValue = d3.max(data.country, function(d,i){\n        return d[1].cumulative_cases;\n    })\n\n    var rScale = d3.scalePow().exponent(0.5)\n      .domain([0, maxValue])\n      .range([0, 15]);\n\n    data.country.forEach(function(d,i){\n        d3.select('#country-'+d[0]).attr('r', rScale(d[1].cumulative_cases))\n        .attr('data-name', d[1].country)\n    })\n    \n    document.getElementById(\"mapoverlay\").appendChild(d3.select('#map_tooltip').node());\n\n\n    function render() {\n        dots\n          .attr(\"cx\", function(d) {\n            return project(([d.lng, d.lat])).x;\n          })\n          .attr(\"cy\", function(d) {\n            return project(([d.lng, d.lat])).y;\n          });\n      }\n\n    map.on(\"viewreset\", render);\n    map.on(\"move\", render);\n    map.on(\"moveend\", render);\n    render(); // Call once to render\n\n    // map.on('mousemove', function (e) {\n    //     var features = map.queryRenderedFeatures(e.point);\n         \n    //     var displayProperties = [\n    //     'type',\n    //     'properties',\n    //     'id',\n    //     'layer',\n    //     'source',\n    //     'sourceLayer',\n    //     'state'\n    //     ];\n         \n    //     var displayFeatures = features.map(function (feat) {\n    //     var displayFeat = {};\n    //     displayProperties.forEach(function (prop) {\n    //     displayFeat[prop] = feat[prop];\n    //     });\n    //     return displayFeat;\n    //     });\n         \n    //     console.log(JSON.stringify(\n    //     displayFeatures,\n    //     null,\n    //     2\n    //     ))\n    //     })\n    updateMap(data, options) ;\n}\n\nexport function updateMap(data, options) {\n   \n    var duration = 1000;\n    var delay = 10;\n\n\n    if(options.map_toggle == 'bi-weekly-change'){\n        \n        var maxValue = d3.max(data.country, function(d,i){\n            return d[1].percent_change;\n        })\n\n        console.log(maxValue);\n\n        var rScale = d3.scalePow().exponent(0.5)\n        .domain([-1, 0, 1])\n        .range([20, 0, 20])\n        .clamp(true);\n\n        d3.selectAll('.country-map').transition('c').duration(duration/1.7).attr('r',0);\n\n        data.country.forEach(function(d,i){\n            d3.select('#country-map-'+d[0])\n            .transition('c').duration(duration).delay(delay)\n            .attr('r', rScale(d[1].percent_change))\n            .style('stroke', function(){\n                // if(d[1].percent_change>1){ return '#E02225'} else { return '#1F558C'}\n                return '#FFF'\n            }).style('fill', function(){\n                if(d[1].percent_change>0){ return '#E02225'} else { return '#1F558C'}\n            })\n        })\n\n    }\n\n    if(options.map_toggle == 'cases'){\n        var maxValue = d3.max(data.country, function(d,i){\n            return d[1].cumulative_cases;\n        })\n\n        var rScale = d3.scalePow().exponent(0.5)\n        .domain([0, maxValue])\n        .range([0, 20]);\n\n        d3.selectAll('.country-map').transition('c').duration(duration/1.7).attr('r',0);\n\n        data.country.forEach(function(d,i){\n            d3.select('#country-map-'+d[0])\n            .transition('c').duration(duration).delay(delay)\n            .attr('r', rScale(d[1].cumulative_cases))\n            .style('fill', '#E02225')\n            .style('stroke', '#FFF');\n        })\n\n    }\n    \n    if(options.map_toggle == 'deaths'){\n        var maxValue = d3.max(data.country, function(d,i){\n            return d[1].cumulative_deaths;\n        })\n\n        var rScale = d3.scalePow().exponent(0.5)\n        .domain([0, maxValue])\n        .range([0, 20]);\n\n        d3.selectAll('.country-map').transition('c').duration(duration/1.7).attr('r',0);\n\n        data.country.forEach(function(d,i){\n            d3.select('#country-map-'+d[0])\n            .transition('c').duration(duration).delay(delay)\n            .attr('r', rScale(d[1].cumulative_deaths))\n            .style('fill', '#E02225')\n            .style('stroke', '#FFF');\n        })\n\n    }\n\n    if(options.map_toggle == 'percent-fully-vaccinated'){\n        var maxValue = d3.max(data.vGroup, function(d,i){\n            return parseFloat(d[1][0].people_fully_vaccinated_per_hundred)/100;\n        })\n\n        var rScale = d3.scalePow().exponent(0.5)\n        .domain([0, 1])\n        .range([0, 20])\n        .clamp(true);\n\n        d3.selectAll('.country-map').transition('c').duration(duration/1.7).attr('r',0);\n\n        data.vGroup.forEach(function(d,i){\n            var peoplevaccinated = parseFloat(d[1][0].people_fully_vaccinated_per_hundred)/100;\n            if(isNaN(peoplevaccinated)) peoplevaccinated = 0;\n            d3.select('#country-map-'+d[1][0].country_code)\n            .transition('c').duration(duration).delay(delay)\n            .attr('r', rScale(peoplevaccinated))\n            .style('stroke', '#FFF')\n            .style('fill', function(){\n                if(peoplevaccinated<=1){ return '#E02225'} else { return '#1F558C'}\n            })\n        })\n\n        \n    }\n\n    if(options.map_toggle == 'percent-vaccine-acceptance'){\n        // var maxValue = d3.max(data.country, function(d,i){\n        //     return d[1].cumulative_deaths;\n        // })\n\n        // var rScale = d3.scalePow().exponent(0.5)\n        // .domain([0, maxValue])\n        // .range([0, 20]);\n\n        // d3.selectAll('.country-map').transition('c').duration(duration/1.7).attr('r',0);\n\n        // data.country.forEach(function(d,i){\n        //     d3.select('#country-map-'+d[0])\n        //     .transition('c').duration(duration).delay(delay)\n        //     .attr('r', rScale(d[1].cumulative_deaths))\n        //     .style('fill', '#E02225')\n        //     .style('stroke', '#FFF');\n        // })\n\n    }\n\n    // tooltips\n\n    var mapTooltip = d3.select('#map_tooltip').attr('opacity', 1).attr('transform', 'translate(0,0)').attr('display', 'none');\n\n    d3.selectAll('.country-map').on('mousemove', function(event, d){\n        // console.log(data);\n        // console.log(data.equity_data);\n        console.log(options.map_toggle);\n\n        var id = d3.select(this).attr('id').substr(12,2);\n        console.log(id);\n        var countryName = data.equity_data.filter(d=>d.country_iso2 == id)[0].country_name;\n        mapTooltip.select('#map_tooltip_name tspan').text(countryName);\n\n        if(options.map_toggle=='cases'){\n            var country = data.country.filter(d=>d[1].country_code == id)[0];\n            if(country.length==0) return false;\n            console.log(country);\n            mapTooltip.select('#map_tooltip_val tspan').text(addCommas(country[1].cumulative_cases)+' cases');\n        }\n\n        if(options.map_toggle=='deaths'){\n            var country = data.country.filter(d=>d[1].country_code == id)[0];\n            if(country.length==0) return false;\n            console.log(country);\n            mapTooltip.select('#map_tooltip_val tspan').text(addCommas(country[1].cumulative_deaths)+' deaths');\n        }\n\n        if(options.map_toggle=='bi-weekly-change'){\n            var country = data.country.filter(d=>d[1].country_code == id)[0];\n            if(country.length==0) return false;\n            console.log(country);\n            var val = ((country[1].percent_change)*100).toFixed(1);\n            var str = '';\n            if(val>=0){\n                str = '% increase';\n            } else {\n                str = '% decrease';\n            }\n            mapTooltip.select('#map_tooltip_val tspan').text(Math.abs(val)+str);\n        }\n\n        if(options.map_toggle=='percent-fully-vaccinated'){\n            var country = data.vGroup.filter(d=>d[1].country_code == id)[0];\n            console.log(country);\n            if(country.length==0) return false;\n            console.log(country);\n            mapTooltip.select('#map_tooltip_val tspan').text(addCommas(country[1].cumulative_deaths)+' deaths');\n        }\n\n\n\n\n\n        var scale = window.innerWidth/1329;\n        mapTooltip\n        .attr('display', 'inline')\n        .attr('transform', 'translate('+project(([d.lng, d.lat])).x+','+project(([d.lng, d.lat])).y+')scale('+scale+')');\n\n        var heightOffset = mapTooltip.node().getBBox();\n        mapTooltip.attr('transform', 'translate('+(project(([d.lng, d.lat])).x+3)+','+(project(([d.lng, d.lat])).y+2-heightOffset.height/2)+')scale('+scale+')');\n\n    }).on('mouseout', function(event){\n        console.log(event);\n        if(event.toElement=='tspan') return false;\n        mapTooltip.attr('display', 'none');\n    })\n\n\n\n\n}\n\nfunction project(d) {\n    return map.project(new mapboxgl.LngLat(d[0], d[1]));\n}\n\n\nexport default createMap;\n"]},"metadata":{},"sourceType":"module"}