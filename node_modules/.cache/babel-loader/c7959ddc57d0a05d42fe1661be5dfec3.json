{"ast":null,"code":"import * as d3 from \"d3\";\nimport moment from 'moment';\nimport colors from './colors';\nimport { filter } from './App';\nimport mapboxgl from '!mapbox-gl'; // eslint-disable-line import/no-webpack-loader-syntax\n\nimport 'mapbox-gl/dist/mapbox-gl.css';\nimport { addCommas } from './HelperFunctions';\nmapboxgl.accessToken = 'pk.eyJ1IjoiZ28taWZyYyIsImEiOiJjams3b2ZhZWswMGFvM3hxeHp2ZHFhOTRrIn0._pqO9OQ2iNeDGrpopJNjpg';\nlet map;\nlet dots;\nlet maxSize = 15;\nlet mapTooltip;\nexport function createMap(data, options, filter) {\n  d3.select('#map-refresh').attr('display', 'none').style('cursor', 'pointer').on('click', function (d, i) {\n    map.setCenter([8, 22]);\n    map.setZoom(0);\n    d3.select('#map-refresh').attr('display', 'none');\n  });\n  map = new mapboxgl.Map({\n    container: 'map_div',\n    // container ID\n    // style: 'mapbox://styles/go-ifrc/ck9tz6f150ub11ip8j97wrsww', // style URL\n    style: 'mapbox://styles/go-ifrc/ckqrsg27f1cwu17pex8w2de2e',\n    // style URL\n    center: [8, 22],\n    // starting position [lng, lat]\n    zoom: 0 // starting zoom\n\n  });\n  map.setRenderWorldCopies(false);\n  map.addControl(new mapboxgl.NavigationControl());\n  map.on('zoom', function () {\n    d3.select('#map-refresh').attr('display', 'inline');\n  });\n  map.on('touchmove', function () {\n    d3.select('#map-refresh').attr('display', 'inline');\n  });\n  map.on('wheel', function () {\n    d3.select('#map-refresh').attr('display', 'inline');\n  });\n  map.on('drag', function () {\n    d3.select('#map-refresh').attr('display', 'inline');\n  });\n  var container = map.getCanvasContainer();\n  var svg = d3.select(container).append(\"svg\").attr('id', 'mapoverlay').attr(\"width\", \"100%\").attr(\"height\", \"24vw\").style(\"position\", \"absolute\").style(\"z-index\", 2);\n  mapTooltip = d3.select('#map_tooltip').attr('opacity', 1).attr('transform', 'translate(0,0)').attr('display', 'inline'); // dots = svg\n  // .selectAll(\".country-map\")\n  // .data(data.world)\n  // .enter()\n  // .append(\"circle\")\n  // .attr('class', 'country-map')\n  // .attr('id', function(d,i){ return 'country-map-'+d.iso2 })\n  // .attr(\"r\", 0)\n  // var maxValue = d3.max(data.country, function(d,i){\n  //     return d[1].cumulative_cases;\n  // })\n  // var rScale = d3.scalePow().exponent(0.5)\n  //   .domain([0, maxValue])\n  //   .range([0, 15]);\n  // data.country.forEach(function(d,i){\n  //     d3.select('#country-'+d[0]).attr('r', rScale(d[1].cumulative_cases))\n  //     .attr('data-name', d[1].country)\n  // })\n\n  d3.select(\"#map_div\").append('svg').attr('width', '18vw').attr('height', '1.5vw').attr('id', 'maplegend').attr('viewBox', '0 0 227 18');\n  document.getElementById(\"maplegend\").appendChild(d3.select('#red_legend').node());\n  document.getElementById(\"maplegend\").appendChild(d3.select('#blue_legend').node());\n  document.getElementById(\"maplegend\").appendChild(d3.select('#bi_legend').node());\n  d3.select('#red_legend').attr('transform', 'translate(20,0)');\n  d3.select('#blue_legend').attr('transform', 'translate(20,0)');\n  d3.select('#bi_legend').attr('transform', 'translate(0,0)');\n  d3.select('#bi_legend').attr('display', 'none');\n  d3.select('#blue_legend').attr('display', 'none');\n  document.getElementById(\"mapoverlay\").appendChild(d3.select('#map_tooltip').node());\n  mapTooltip.attr('display', 'none');\n  map.on('load', function (e) {\n    map.setPaintProperty('countries', 'fill-opacity-transition', {\n      duration: 0,\n      delay: 0\n    });\n    updateMap(data, options);\n  });\n}\nexport function updateMap(data, options) {\n  var duration = 800;\n  var delay = 10;\n  map.setLayoutProperty('countries', 'visibility', 'none');\n\n  if (options.map_toggle == 'bi-weekly-change') {\n    var maxIncrease = d3.max(data.country, function (d, i) {\n      return d[1].percent_change;\n    });\n    var maxDecrease = d3.min(data.country, function (d, i) {\n      return d[1].percent_change;\n    });\n    d3.select('#bi_legend').attr('display', 'inline');\n    d3.select('#blue_legend').attr('display', 'none');\n    d3.select('#red_legend').attr('display', 'none');\n    maxIncrease = Math.ceil(maxIncrease / 0.1) * 0.1;\n    maxDecrease = Math.floor(maxDecrease / 0.1) * 0.1;\n    if (maxIncrease > 1) maxIncrease = 1;\n    if (maxDecrease < -1) maxDecrease = -1;\n    d3.select('#bi_legend_dec_val').attr('text-anchor', 'end');\n\n    if (maxIncrease < 1) {\n      d3.select('#bi_legend_inc_val tspan').text(Math.round(maxIncrease * 100) + '%');\n    } else {\n      d3.select('#bi_legend_inc_val tspan').text(Math.round(maxIncrease * 100) + '% +');\n    }\n\n    if (maxDecrease > -1) {\n      d3.select('#bi_legend_dec_val tspan').text(Math.round(Math.abs(maxDecrease) * 100) + '%').attr('dx', 14);\n    } else {\n      d3.select('#bi_legend_dec_val tspan').text(Math.round(Math.abs(maxDecrease) * 100) + '% +').attr('dx', 14);\n    } // var rScale = d3.scalePow().exponent(0.5)\n    // .domain([-1, 0, 1])\n    // .range([maxSize, 0, maxSize])\n    // .clamp(true);\n    // d3.selectAll('.country-map').transition('c').duration(duration/1.7).attr('r',0);\n    // data.country.forEach(function(d,i){\n    //     d3.select('#country-map-'+d[0])\n    //     .transition('c').duration(duration).delay(delay)\n    //     .attr('r', rScale(d[1].percent_change))\n    //     .style('stroke', function(){\n    //         // if(d[1].percent_change>1){ return '#E02225'} else { return '#1F558C'}\n    //         return '#FFF'\n    //     }).style('fill', function(){\n    //         if(d[1].percent_change>0){ return colors.red } else { return colors.blue}\n    //     })\n    // })\n\n\n    var colorScale = d3.scaleLinear() // .domain([-1, 0, 1])\n    .domain([maxDecrease, 0, maxIncrease]).range([colors.blue, colors.lightgrey, colors.red]); // .clamp(true);\n\n    var fillColorArray = ['case'];\n    data.country.forEach(function (d, i) {\n      fillColorArray.push(['==', ['get', \"iso\"], d.country_code]);\n      fillColorArray.push(colorScale(d[1].percent_change));\n    });\n\n    if (fillColorArray.length > 1) {\n      fillColorArray.push(colors.darkgrey);\n      map.setPaintProperty('countries', 'fill-color', fillColorArray);\n    }\n  }\n\n  if (options.map_toggle == 'cases') {\n    var maxValue = d3.max(data.country, function (d, i) {\n      return d.cumulative_cases_per_100k;\n    });\n    d3.select('#bi_legend').attr('display', 'none');\n    d3.select('#blue_legend').attr('display', 'none');\n    d3.select('#red_legend').attr('display', 'inline');\n    d3.select('#red_legend_title tspan').text('Cases per 100k');\n\n    if (maxValue > 1000) {\n      maxValue = Math.ceil(maxValue / 100) * 100;\n    } else {\n      maxValue = Math.ceil(maxValue / 10) * 10;\n    }\n\n    d3.select('#red_legend_val tspan').text(addCommas(maxValue)); // var rScale = d3.scalePow().exponent(0.5)\n    // .domain([0, maxValue])\n    // .range([0, maxSize]);\n    // d3.selectAll('.country-map').transition('c').duration(duration/1.7).attr('r',0);\n    // data.country.forEach(function(d,i){\n    //     d3.select('#country-map-'+d[0])\n    //     .transition('c').duration(duration).delay(delay)\n    //     .attr('r', rScale(d[1].cumulative_cases))\n    //     .style('fill', colors.red)\n    //     .style('stroke', '#FFF');\n    // })\n\n    var colorScale = d3.scaleLinear().domain([0, maxValue]).range([colors.lightgrey, colors.red]);\n    var fillColorArray = ['case'];\n    data.country.forEach(function (d, i) {\n      if (i == 1) console.log(d);\n      fillColorArray.push(['==', ['get', \"iso\"], d.country_code]);\n      fillColorArray.push(colorScale(d.cumulative_cases_per_100k));\n    });\n\n    if (fillColorArray.length > 1) {\n      fillColorArray.push(colors.darkgrey);\n      map.setPaintProperty('countries', 'fill-color', fillColorArray);\n    }\n  }\n\n  if (options.map_toggle == 'deaths') {\n    var maxValue = d3.max(data.country, function (d, i) {\n      return d.cumulative_deaths_per_100k;\n    });\n    d3.select('#bi_legend').attr('display', 'none');\n    d3.select('#blue_legend').attr('display', 'none');\n    d3.select('#red_legend').attr('display', 'inline');\n    d3.select('#red_legend_title tspan').text('Deaths per 100k');\n\n    if (maxValue > 1000) {\n      maxValue = Math.ceil(maxValue / 100) * 100;\n    } else {\n      maxValue = Math.ceil(maxValue / 10) * 10;\n    }\n\n    d3.select('#red_legend_val tspan').text(addCommas(maxValue)); // var rScale = d3.scalePow().exponent(0.5)\n    // .domain([0, maxValue])\n    // .range([0, maxSize]);\n    // d3.selectAll('.country-map').transition('c').duration(duration/1.7).attr('r',0);\n    // data.country.forEach(function(d,i){\n    //     d3.select('#country-map-'+d[0])\n    //     .transition('c').duration(duration).delay(delay)\n    //     .attr('r', rScale(d[1].cumulative_deaths))\n    //     .style('fill', colors.red)\n    //     .style('stroke', '#FFF');\n    // })\n\n    var colorScale = d3.scaleLinear().domain([0, maxValue]).range([colors.lightgrey, colors.red]);\n    var fillColorArray = ['case'];\n    data.country.forEach(function (d, i) {\n      fillColorArray.push(['==', ['get', \"iso\"], d.country_code]);\n      fillColorArray.push(colorScale(d.cumulative_deaths_per_100k));\n    });\n\n    if (fillColorArray.length > 1) {\n      fillColorArray.push(colors.darkgrey);\n      map.setPaintProperty('countries', 'fill-color', fillColorArray);\n    }\n  }\n\n  if (options.map_toggle == 'percent-fully-vaccinated') {\n    d3.select('#bi_legend').attr('display', 'none');\n    d3.select('#blue_legend').attr('display', 'inline');\n    d3.select('#red_legend').attr('display', 'none');\n    d3.select('#blue_legend_title tspan').text('Percent fully vaccinated');\n    d3.select('#blue_legend_val tspan').text('100%'); // var rScale = d3.scalePow().exponent(0.55)\n    // .domain([0, 1])\n    // .range([1, maxSize])\n    // .clamp(true);\n    // d3.selectAll('.country-map').transition('c').duration(duration/1.7).attr('r',0);\n    // data.vGroup.forEach(function(d,i){\n    //     var peoplevaccinated = parseFloat(d[1][0].people_fully_vaccinated_per_hundred)/100;\n    //     if(isNaN(peoplevaccinated)) peoplevaccinated = 0;\n    //     d3.select('#country-map-'+d[1][0].country_code)\n    //     .transition('c').duration(duration).delay(delay)\n    //     .attr('r', rScale(peoplevaccinated))\n    //     .style('stroke', '#FFF')\n    //     .style('fill', function(){\n    //         return colors.blue;\n    //     })\n    // })\n\n    var colorScale = d3.scaleLinear().domain([0, 1]).range([colors.lightgrey, colors.blue]).clamp(true);\n    var fillColorArray = ['case'];\n    data.country.forEach(function (d, i) {\n      var peoplevaccinated = parseFloat(d.people_fully_vaccinated_per_hundred) / 100;\n      if (isNaN(peoplevaccinated)) peoplevaccinated = 0;\n\n      if (peoplevaccinated > 0) {\n        if (d.country_code) fillColorArray.push(['==', ['get', \"iso\"], d.country_code]);\n        if (d.country_code) fillColorArray.push(colorScale(peoplevaccinated));\n      }\n    });\n\n    if (fillColorArray.length > 1) {\n      fillColorArray.push(colors.darkgrey);\n      map.setPaintProperty('countries', 'fill-color', fillColorArray);\n    } else {\n      map.setPaintProperty('countries', 'fill-color', colors.darkgrey);\n    }\n  }\n\n  if (options.map_toggle == 'percent-vaccine-acceptance') {\n    d3.select('#bi_legend').attr('display', 'none');\n    d3.select('#blue_legend').attr('display', 'inline');\n    d3.select('#red_legend').attr('display', 'none');\n    d3.select('#blue_legend_title tspan').text('% vaccine acceptance');\n    d3.select('#blue_legend_val tspan').text('100%'); // var rScale = d3.scalePow().exponent(1)\n    // .domain([0, 1])\n    // .range([1, maxSize*.7])\n    // // .clamp(true);\n    // d3.selectAll('.country-map').transition('c').duration(duration/1.7).attr('r',0);\n    // data.vGroup.forEach(function(d,i){\n    //     var vaccine_acceptance_percent = parseFloat(d[1][0].vaccine_acceptance_percent/100);\n    //     if(isNaN(vaccine_acceptance_percent)) vaccine_acceptance_percent = 0;\n    //     d3.select('#country-map-'+d[1][0].country_code)\n    //     .transition('c').duration(duration).delay(delay)\n    //     .attr('r', rScale(vaccine_acceptance_percent))\n    //     .style('stroke', '#FFF')\n    //     .style('fill', function(){\n    //         return colors.blue;\n    //     })\n    // })\n\n    var colorScale = d3.scaleLinear().domain([0, 1]).range([colors.lightgrey, colors.blue]).clamp(true);\n    var fillColorArray = ['case'];\n    data.vGroup.forEach(function (d, i) {\n      var vaccine_acceptance_percent = parseFloat(d.vaccine_acceptance_percent) / 100;\n      if (isNaN(vaccine_acceptance_percent)) vaccine_acceptance_percent = 0;\n\n      if (vaccine_acceptance_percent > 0) {\n        if (d.country_code) fillColorArray.push(['==', ['get', \"iso\"], d.country_code]);\n        if (d.country_code) fillColorArray.push(colorScale(vaccine_acceptance_percent));\n      }\n    });\n\n    if (fillColorArray.length > 1) {\n      fillColorArray.push(colors.darkgrey);\n      map.setPaintProperty('countries', 'fill-color', fillColorArray);\n    } else {\n      map.setPaintProperty('countries', 'fill-color', colors.darkgrey);\n    }\n  }\n\n  mapTooltip.attr('display', 'none');\n  map.on('mousemove', function (e) {\n    var features = map.queryRenderedFeatures(e.point);\n    var displayProperties = ['type', 'properties', 'id', 'layer', 'source', 'sourceLayer', 'state'];\n\n    if (features.length == 1 && features[0].layer.id == 'countries') {\n      var id = features[0].properties.iso;\n      var countryfiltered = data.equity_data.filter(d => d.country_iso2 == id);\n      var countryName;\n      if (countryfiltered[0]) countryName = countryfiltered[0].country_name;\n      mapTooltip.select('#map_tooltip_name tspan').text(countryName);\n\n      if (mapTooltip.select('#map_tooltip_name tspan').text().length == 0) {\n        mapTooltip.attr('display', 'none');\n      }\n\n      ;\n\n      if (options.map_toggle == 'cases') {\n        var country = data.country.filter(d => d.country_code == id)[0];\n        if (!country || country.length == 0) return false;\n        mapTooltip.select('#map_tooltip_val tspan').text(addCommas(Math.round(country.cumulative_cases_per_100k)) + ' cases per 100k');\n      }\n\n      if (options.map_toggle == 'deaths') {\n        var country = data.country.filter(d => d.country_code == id)[0];\n        if (!country || country.length == 0) return false;\n        mapTooltip.select('#map_tooltip_val tspan').text(addCommas(Math.round(country.cumulative_deaths_per_100k)) + ' deaths per 100k');\n      }\n\n      if (options.map_toggle == 'bi-weekly-change') {\n        var country = data.country.filter(d => d.country_code == id);\n        if (!country || country.length == 0) return false;\n        var val = (country[0].percent_change * 100).toFixed(1);\n        var str = '';\n\n        if (val >= 0) {\n          str = '% increase';\n        } else {\n          str = '% decrease';\n        }\n\n        mapTooltip.select('#map_tooltip_val tspan').text(Math.abs(val) + str);\n      }\n\n      if (options.map_toggle == 'percent-fully-vaccinated') {\n        var country = data.country.filter(d => d.country_code == id);\n        if (!country || country.length == 0) return false;\n        var val = parseFloat(country[0].people_fully_vaccinated_per_hundred).toFixed(1);\n\n        if (isNaN(val)) {\n          val = '-';\n        } else {\n          val = val + '% fully vaccinated';\n        }\n\n        mapTooltip.select('#map_tooltip_val tspan').text(val);\n      }\n\n      if (options.map_toggle == 'percent-vaccine-acceptance') {\n        var country = data.country.filter(d => d.country_code == id);\n        if (!country || country.length == 0) return false;\n        var val = parseFloat(country[0].vaccine_acceptance_percent).toFixed(1);\n\n        if (isNaN(val)) {\n          val = '-';\n        } else {\n          val = val + '% vaccine acceptance';\n        }\n\n        mapTooltip.select('#map_tooltip_val tspan').text(val);\n      }\n\n      var str = mapTooltip.select('#map_tooltip_val tspan').text();\n      if (str.includes('NaN')) mapTooltip.attr('display', 'none');\n      d3.select('#map_tooltip_bg').attr('width', 20);\n      var bbox = d3.select('#map_tooltip_text').node().getBBox();\n      d3.select('#map_tooltip_bg').attr('width', parseFloat(bbox.width) + 15);\n      var scale = window.innerWidth / 1329;\n      mapTooltip.attr('display', 'inline').attr('transform', 'translate(' + (e.point.x + 20) + ',' + e.point.y + ')scale(' + scale + ')');\n      var heightOffset = mapTooltip.node().getBBox();\n\n      if (mapTooltip.select('#map_tooltip_name tspan').text().length == 0) {\n        mapTooltip.attr('display', 'none');\n      }\n\n      ; // mapTooltip.attr('transform', 'translate('+(project(([d.lng, d.lat])).x+3)+','+(project(([d.lng, d.lat])).y+2-heightOffset.height/2)+')scale('+scale+')');\n    } else {\n      mapTooltip.attr('display', 'none');\n    }\n  }); // function render() {\n  //     dots\n  //       .attr(\"cx\", function(d) {\n  //         return project(([d.lng, d.lat])).x;\n  //       })\n  //       .attr(\"cy\", function(d) {\n  //         return project(([d.lng, d.lat])).y;\n  //       });\n  //   }\n  // map.on(\"viewreset\", render);\n  // map.on(\"move\", render);\n  // map.on(\"moveend\", render);\n  // render(); // Call once to render\n  // tooltips\n  // var mapTooltip = d3.select('#map_tooltip').attr('opacity', 1).attr('transform', 'translate(0,0)').attr('display', 'none');\n  // d3.selectAll('.country-map').on('mousemove', function(event, d){\n  //     var id = d3.select(this).attr('id').substr(12,2);\n  //     var countryfiltered = data.equity_data.filter(d=>d.country_iso2 == id);\n  //     var countryName;\n  //     if(countryfiltered[0]) countryName = countryfiltered[0].country_name;\n  //     mapTooltip.select('#map_tooltip_name tspan').text(countryName);\n  //     if(options.map_toggle=='cases'){\n  //         var country = data.country.filter(d=>d.country_code == id)[0];\n  //         if((!country)||(country.length==0)) return false;\n  //         mapTooltip.select('#map_tooltip_val tspan').text(addCommas(country[1].cumulative_cases)+' cases');\n  //     }\n  //     if(options.map_toggle=='deaths'){\n  //         var country = data.country.filter(d=>d.country_code == id)[0];\n  //         if((!country)||(country.length==0)) return false;\n  //         mapTooltip.select('#map_tooltip_val tspan').text(addCommas(country[1].cumulative_deaths)+' deaths');\n  //     }\n  //     if(options.map_toggle=='bi-weekly-change'){\n  //         var country = data.country.filter(d=>d.country_code == id)[0];\n  //         if((!country)||(country.length==0)) return false;\n  //         var val = ((country[1].percent_change)*100).toFixed(1);\n  //         var str = '';\n  //         if(val>=0){\n  //             str = '% increase';\n  //         } else {\n  //             str = '% decrease';\n  //         }\n  //         mapTooltip.select('#map_tooltip_val tspan').text(Math.abs(val)+str);\n  //     }\n  //     if(options.map_toggle=='percent-fully-vaccinated'){\n  //         var country = data.vGroup.filter(d=>d[1][0].country_code == id)[0][1];\n  //         if((!country)||(country.length==0)) return false;\n  //         mapTooltip.select('#map_tooltip_val tspan').text(parseFloat(country[0].people_fully_vaccinated_per_hundred).toFixed(1)+'% fully vaccinated');\n  //     }\n  //     if(options.map_toggle=='percent-vaccine-acceptance'){\n  //         var country = data.vGroup.filter(d=>d[1][0].country_code == id)[0][1];\n  //         if((!country)||(country.length==0)) return false;\n  //         mapTooltip.select('#map_tooltip_val tspan').text(parseFloat(country[0].vaccine_acceptance_percent).toFixed(1)+'% vaccine acceptance');\n  //     }\n  //     d3.select('#map_tooltip_bg').attr('width', 0)\n  //     var bbox = mapTooltip.node().getBBox();\n  //     d3.select('#map_tooltip_bg').attr('width', (parseFloat(bbox.width)+2))\n  //     var scale = window.innerWidth/1329;\n  //     mapTooltip\n  //     .attr('display', 'inline')\n  //     .attr('transform', 'translate('+project(([d.lng, d.lat])).x+','+project(([d.lng, d.lat])).y+')scale('+scale+')');\n  //     var heightOffset = mapTooltip.node().getBBox();\n  //     mapTooltip.attr('transform', 'translate('+(project(([d.lng, d.lat])).x+3)+','+(project(([d.lng, d.lat])).y+2-heightOffset.height/2)+')scale('+scale+')');\n  // }).on('mouseout', function(event){\n  //     if(event.toElement=='tspan') return false;\n  //     mapTooltip.attr('display', 'none');\n  // })\n\n  map.setLayoutProperty('countries', 'visibility', 'visible');\n} // function project(d) {\n//     return map.project(new mapboxgl.LngLat(d[0], d[1]));\n// }\n\nexport default createMap;","map":{"version":3,"sources":["/Users/matthewsmawfield/www/ifrc-covid-dataviz/src/Map.js"],"names":["d3","moment","colors","filter","mapboxgl","addCommas","accessToken","map","dots","maxSize","mapTooltip","createMap","data","options","select","attr","style","on","d","i","setCenter","setZoom","Map","container","center","zoom","setRenderWorldCopies","addControl","NavigationControl","getCanvasContainer","svg","append","document","getElementById","appendChild","node","e","setPaintProperty","duration","delay","updateMap","setLayoutProperty","map_toggle","maxIncrease","max","country","percent_change","maxDecrease","min","Math","ceil","floor","text","round","abs","colorScale","scaleLinear","domain","range","blue","lightgrey","red","fillColorArray","forEach","push","country_code","length","darkgrey","maxValue","cumulative_cases_per_100k","console","log","cumulative_deaths_per_100k","clamp","peoplevaccinated","parseFloat","people_fully_vaccinated_per_hundred","isNaN","vGroup","vaccine_acceptance_percent","features","queryRenderedFeatures","point","displayProperties","layer","id","properties","iso","countryfiltered","equity_data","country_iso2","countryName","country_name","val","toFixed","str","includes","bbox","getBBox","width","scale","window","innerWidth","x","y","heightOffset"],"mappings":"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","sourcesContent":["import * as d3 from \"d3\";\nimport moment from 'moment';\nimport colors from './colors';\nimport {filter} from './App';\nimport mapboxgl from '!mapbox-gl'; // eslint-disable-line import/no-webpack-loader-syntax\nimport 'mapbox-gl/dist/mapbox-gl.css';\nimport {addCommas} from './HelperFunctions';\n\nmapboxgl.accessToken = 'pk.eyJ1IjoiZ28taWZyYyIsImEiOiJjams3b2ZhZWswMGFvM3hxeHp2ZHFhOTRrIn0._pqO9OQ2iNeDGrpopJNjpg';\n\nlet map;\nlet dots; \nlet maxSize = 15; \nlet mapTooltip;\n\nexport function createMap(data, options, filter) {\n\n    d3.select('#map-refresh').attr('display', 'none').style('cursor', 'pointer')\n    .on('click', function(d,i){\n        map.setCenter([8, 22]);\n        map.setZoom(0);\n        d3.select('#map-refresh').attr('display', 'none');\n    })\n    \n    map = new mapboxgl.Map({\n        container: 'map_div', // container ID\n        // style: 'mapbox://styles/go-ifrc/ck9tz6f150ub11ip8j97wrsww', // style URL\n        style: 'mapbox://styles/go-ifrc/ckqrsg27f1cwu17pex8w2de2e', // style URL\n        center: [8, 22], // starting position [lng, lat]\n        zoom: 0 // starting zoom\n    });\n\n    map.setRenderWorldCopies(false);\n    map.addControl(new mapboxgl.NavigationControl());\n    \n    map.on('zoom', function() {\n        d3.select('#map-refresh').attr('display', 'inline');\n    });\n\n    map.on('touchmove', function() {\n        d3.select('#map-refresh').attr('display', 'inline');\n    });\n\n    map.on('wheel', function() {\n        d3.select('#map-refresh').attr('display', 'inline');\n    });\n\n    map.on('drag', function() {\n        d3.select('#map-refresh').attr('display', 'inline');\n    });\n\n    var container = map.getCanvasContainer();\n\n    var svg = d3\n    .select(container)\n    .append(\"svg\")\n    .attr('id', 'mapoverlay')\n    .attr(\"width\", \"100%\")\n    .attr(\"height\", \"24vw\")\n    .style(\"position\", \"absolute\")\n    .style(\"z-index\", 2);\n\n    mapTooltip = d3.select('#map_tooltip').attr('opacity', 1).attr('transform', 'translate(0,0)').attr('display', 'inline');\n\n    // dots = svg\n    // .selectAll(\".country-map\")\n    // .data(data.world)\n    // .enter()\n    // .append(\"circle\")\n    // .attr('class', 'country-map')\n    // .attr('id', function(d,i){ return 'country-map-'+d.iso2 })\n    // .attr(\"r\", 0)\n    \n\n    // var maxValue = d3.max(data.country, function(d,i){\n    //     return d[1].cumulative_cases;\n    // })\n\n    // var rScale = d3.scalePow().exponent(0.5)\n    //   .domain([0, maxValue])\n    //   .range([0, 15]);\n\n    // data.country.forEach(function(d,i){\n    //     d3.select('#country-'+d[0]).attr('r', rScale(d[1].cumulative_cases))\n    //     .attr('data-name', d[1].country)\n    // })\n    \n    d3.select(\"#map_div\").append('svg')\n    .attr('width', '18vw')\n    .attr('height', '1.5vw')\n    .attr('id', 'maplegend')\n    .attr('viewBox', '0 0 227 18')\n\n    document.getElementById(\"maplegend\").appendChild(d3.select('#red_legend').node());\n    document.getElementById(\"maplegend\").appendChild(d3.select('#blue_legend').node());\n    document.getElementById(\"maplegend\").appendChild(d3.select('#bi_legend').node());\n\n    d3.select('#red_legend').attr('transform', 'translate(20,0)');\n    d3.select('#blue_legend').attr('transform', 'translate(20,0)');\n    d3.select('#bi_legend').attr('transform', 'translate(0,0)');\n\n    d3.select('#bi_legend').attr('display', 'none');\n    d3.select('#blue_legend').attr('display', 'none');\n\n    document.getElementById(\"mapoverlay\").appendChild(d3.select('#map_tooltip').node());\n    mapTooltip.attr('display', 'none')  \n\n    map.on('load', function (e) {\n\n        map.setPaintProperty('countries', 'fill-opacity-transition', {duration: 0, delay: 0});\n\n        updateMap(data, options) ;\n\n    });\n\n}\n\nexport function updateMap(data, options) {\n   \n    var duration = 800;\n    var delay = 10;\n\n    map.setLayoutProperty(\n        'countries',\n        'visibility',\n        'none'\n    );\n\n    if(options.map_toggle == 'bi-weekly-change'){\n        \n        var maxIncrease = d3.max(data.country, function(d,i){\n            return d[1].percent_change;\n        })\n\n        var maxDecrease = d3.min(data.country, function(d,i){\n            return d[1].percent_change;\n        })\n\n        d3.select('#bi_legend').attr('display', 'inline');\n        d3.select('#blue_legend').attr('display', 'none');\n        d3.select('#red_legend').attr('display', 'none');\n\n        maxIncrease = (Math.ceil(maxIncrease/0.1))*0.1;\n        maxDecrease = (Math.floor(maxDecrease/0.1))*0.1;\n\n        if(maxIncrease>1) maxIncrease = 1;\n        if(maxDecrease<-1) maxDecrease = -1;\n\n        d3.select('#bi_legend_dec_val').attr('text-anchor', 'end');\n        if(maxIncrease<1){\n            d3.select('#bi_legend_inc_val tspan').text(Math.round(maxIncrease*100)+'%');\n        } else {\n            d3.select('#bi_legend_inc_val tspan').text(Math.round(maxIncrease*100)+'% +');\n        }\n        if(maxDecrease>-1){\n            d3.select('#bi_legend_dec_val tspan').text(Math.round(Math.abs(maxDecrease)*100)+'%').attr('dx', 14);\n        } else {\n            d3.select('#bi_legend_dec_val tspan').text(Math.round(Math.abs(maxDecrease)*100)+'% +').attr('dx', 14);\n        }\n\n        // var rScale = d3.scalePow().exponent(0.5)\n        // .domain([-1, 0, 1])\n        // .range([maxSize, 0, maxSize])\n        // .clamp(true);\n\n        // d3.selectAll('.country-map').transition('c').duration(duration/1.7).attr('r',0);\n\n        // data.country.forEach(function(d,i){\n        //     d3.select('#country-map-'+d[0])\n        //     .transition('c').duration(duration).delay(delay)\n        //     .attr('r', rScale(d[1].percent_change))\n        //     .style('stroke', function(){\n        //         // if(d[1].percent_change>1){ return '#E02225'} else { return '#1F558C'}\n        //         return '#FFF'\n        //     }).style('fill', function(){\n        //         if(d[1].percent_change>0){ return colors.red } else { return colors.blue}\n        //     })\n        // })\n\n        var colorScale = d3.scaleLinear()\n        // .domain([-1, 0, 1])\n        .domain([maxDecrease, 0, maxIncrease])\n        .range([colors.blue, colors.lightgrey, colors.red])\n        // .clamp(true);\n\n        var fillColorArray = ['case']\n        data.country.forEach(function(d,i){\n            fillColorArray.push(['==', ['get', \"iso\"], d.country_code]);\n            fillColorArray.push(colorScale(d[1].percent_change));\n        });\n\n        if(fillColorArray.length>1){\n            fillColorArray.push(colors.darkgrey)\n            map.setPaintProperty(\n                'countries', \n                'fill-color', fillColorArray\n            );\n        }\n        \n    }\n\n    if(options.map_toggle == 'cases'){\n\n        var maxValue = d3.max(data.country, function(d,i){\n            return d.cumulative_cases_per_100k;\n        });\n\n        d3.select('#bi_legend').attr('display', 'none');\n        d3.select('#blue_legend').attr('display', 'none');\n        d3.select('#red_legend').attr('display', 'inline');\n\n        d3.select('#red_legend_title tspan').text('Cases per 100k');\n\n        if(maxValue>1000){\n            maxValue = (Math.ceil(maxValue/100))*100;\n        } else {\n            maxValue = (Math.ceil(maxValue/10))*10;\n        }\n\n        d3.select('#red_legend_val tspan').text(addCommas(maxValue));\n\n        // var rScale = d3.scalePow().exponent(0.5)\n        // .domain([0, maxValue])\n        // .range([0, maxSize]);\n\n        // d3.selectAll('.country-map').transition('c').duration(duration/1.7).attr('r',0);\n\n        // data.country.forEach(function(d,i){\n        //     d3.select('#country-map-'+d[0])\n        //     .transition('c').duration(duration).delay(delay)\n        //     .attr('r', rScale(d[1].cumulative_cases))\n        //     .style('fill', colors.red)\n        //     .style('stroke', '#FFF');\n        // })\n\n        var colorScale = d3.scaleLinear()\n        .domain([0, maxValue])\n        .range([colors.lightgrey, colors.red]);\n\n        var fillColorArray = ['case']\n        data.country.forEach(function(d,i){\n            if(i==1) console.log(d);\n            fillColorArray.push(['==', ['get', \"iso\"], d.country_code]);\n            fillColorArray.push(colorScale(d.cumulative_cases_per_100k));\n        });\n\n        if(fillColorArray.length>1){\n            fillColorArray.push(colors.darkgrey)\n            map.setPaintProperty(\n                'countries', \n                'fill-color', fillColorArray\n            );\n        }\n\n    }\n    \n    if(options.map_toggle == 'deaths'){\n\n        var maxValue = d3.max(data.country, function(d,i){\n            return d.cumulative_deaths_per_100k;\n        })\n\n        d3.select('#bi_legend').attr('display', 'none');\n        d3.select('#blue_legend').attr('display', 'none');\n        d3.select('#red_legend').attr('display', 'inline');\n\n        d3.select('#red_legend_title tspan').text('Deaths per 100k');\n\n        if(maxValue>1000){\n            maxValue = (Math.ceil(maxValue/100))*100;\n        } else {\n            maxValue = (Math.ceil(maxValue/10))*10;\n        }\n\n        d3.select('#red_legend_val tspan').text(addCommas(maxValue));\n\n        // var rScale = d3.scalePow().exponent(0.5)\n        // .domain([0, maxValue])\n        // .range([0, maxSize]);\n\n        // d3.selectAll('.country-map').transition('c').duration(duration/1.7).attr('r',0);\n\n        // data.country.forEach(function(d,i){\n        //     d3.select('#country-map-'+d[0])\n        //     .transition('c').duration(duration).delay(delay)\n        //     .attr('r', rScale(d[1].cumulative_deaths))\n        //     .style('fill', colors.red)\n        //     .style('stroke', '#FFF');\n        // })\n\n        var colorScale = d3.scaleLinear()\n        .domain([0, maxValue])\n        .range([colors.lightgrey, colors.red]);\n\n        var fillColorArray = ['case']\n\n        data.country.forEach(function(d,i){\n            fillColorArray.push(['==', ['get', \"iso\"], d.country_code]);\n            fillColorArray.push(colorScale(d.cumulative_deaths_per_100k));\n        });\n\n        if(fillColorArray.length>1){\n            fillColorArray.push(colors.darkgrey)\n            map.setPaintProperty(\n                'countries', \n                'fill-color', fillColorArray\n            );\n        }\n    }\n\n    if(options.map_toggle == 'percent-fully-vaccinated'){\n\n        d3.select('#bi_legend').attr('display', 'none');\n        d3.select('#blue_legend').attr('display', 'inline');\n        d3.select('#red_legend').attr('display', 'none');\n        d3.select('#blue_legend_title tspan').text('Percent fully vaccinated');\n        d3.select('#blue_legend_val tspan').text('100%');\n\n        // var rScale = d3.scalePow().exponent(0.55)\n        // .domain([0, 1])\n        // .range([1, maxSize])\n        // .clamp(true);\n\n        // d3.selectAll('.country-map').transition('c').duration(duration/1.7).attr('r',0);\n\n        // data.vGroup.forEach(function(d,i){\n        //     var peoplevaccinated = parseFloat(d[1][0].people_fully_vaccinated_per_hundred)/100;\n        //     if(isNaN(peoplevaccinated)) peoplevaccinated = 0;\n        //     d3.select('#country-map-'+d[1][0].country_code)\n        //     .transition('c').duration(duration).delay(delay)\n        //     .attr('r', rScale(peoplevaccinated))\n        //     .style('stroke', '#FFF')\n        //     .style('fill', function(){\n        //         return colors.blue;\n        //     })\n        // })\n\n        var colorScale = d3.scaleLinear()\n        .domain([0, 1])\n        .range([colors.lightgrey, colors.blue])\n        .clamp(true);\n\n        var fillColorArray = ['case']\n        data.country.forEach(function(d,i){\n            var peoplevaccinated = parseFloat(d.people_fully_vaccinated_per_hundred)/100;\n            if(isNaN(peoplevaccinated)) peoplevaccinated = 0;\n            if(peoplevaccinated>0){\n                if(d.country_code) fillColorArray.push(['==', ['get', \"iso\"], d.country_code]);\n                if(d.country_code) fillColorArray.push(colorScale(peoplevaccinated));\n            }\n        });\n\n        if(fillColorArray.length>1){\n            fillColorArray.push(colors.darkgrey)\n            map.setPaintProperty(\n                'countries', \n                'fill-color', fillColorArray\n            );\n        } else {\n            map.setPaintProperty(\n                'countries', \n                'fill-color',\n                colors.darkgrey\n            );\n        }\n        \n    }\n\n    if(options.map_toggle == 'percent-vaccine-acceptance'){\n\n\n        d3.select('#bi_legend').attr('display', 'none');\n        d3.select('#blue_legend').attr('display', 'inline');\n        d3.select('#red_legend').attr('display', 'none');\n        d3.select('#blue_legend_title tspan').text('% vaccine acceptance');\n        d3.select('#blue_legend_val tspan').text('100%');\n        \n        // var rScale = d3.scalePow().exponent(1)\n        // .domain([0, 1])\n        // .range([1, maxSize*.7])\n        // // .clamp(true);\n\n        // d3.selectAll('.country-map').transition('c').duration(duration/1.7).attr('r',0);\n\n        // data.vGroup.forEach(function(d,i){\n        //     var vaccine_acceptance_percent = parseFloat(d[1][0].vaccine_acceptance_percent/100);\n            \n        //     if(isNaN(vaccine_acceptance_percent)) vaccine_acceptance_percent = 0;\n\n        //     d3.select('#country-map-'+d[1][0].country_code)\n        //     .transition('c').duration(duration).delay(delay)\n        //     .attr('r', rScale(vaccine_acceptance_percent))\n        //     .style('stroke', '#FFF')\n        //     .style('fill', function(){\n        //         return colors.blue;\n        //     })\n        // })\n\n        var colorScale = d3.scaleLinear()\n        .domain([0, 1])\n        .range([colors.lightgrey, colors.blue])\n        .clamp(true);\n\n        var fillColorArray = ['case']\n        data.vGroup.forEach(function(d,i){\n            var vaccine_acceptance_percent = parseFloat(d.vaccine_acceptance_percent)/100;\n            if(isNaN(vaccine_acceptance_percent)) vaccine_acceptance_percent = 0;\n            if(vaccine_acceptance_percent>0){\n                if(d.country_code) fillColorArray.push(['==', ['get', \"iso\"], d.country_code]);\n                if(d.country_code) fillColorArray.push(colorScale(vaccine_acceptance_percent));\n            }\n        });\n\n        if(fillColorArray.length>1){\n            fillColorArray.push(colors.darkgrey)\n            map.setPaintProperty(\n                'countries', \n                'fill-color', fillColorArray\n            );\n        } else {\n            map.setPaintProperty(\n                'countries', \n                'fill-color',\n                colors.darkgrey\n            );\n        }\n\n    }\n\n    mapTooltip.attr('display', 'none')  \n\n    map.on('mousemove', function (e) {\n        var features = map.queryRenderedFeatures(e.point);\n         \n        var displayProperties = [\n        'type',\n        'properties',\n        'id',\n        'layer',\n        'source',\n        'sourceLayer',\n        'state'\n        ];\n         \n        if((features.length==1)&&(features[0].layer.id=='countries')){\n\n            var id = features[0].properties.iso;\n            var countryfiltered = data.equity_data.filter(d=>d.country_iso2 == id);\n            var countryName;\n            if(countryfiltered[0]) countryName = countryfiltered[0].country_name;\n    \n            mapTooltip.select('#map_tooltip_name tspan').text(countryName);\n  \n            if(mapTooltip.select('#map_tooltip_name tspan').text().length==0){\n                mapTooltip\n                .attr('display', 'none');\n            };\n            \n            if(options.map_toggle=='cases'){\n                var country = data.country.filter(d=>d.country_code == id)[0];\n                if((!country)||(country.length==0)) return false;\n                mapTooltip.select('#map_tooltip_val tspan').text(addCommas(Math.round(country.cumulative_cases_per_100k))+' cases per 100k');\n            }\n    \n            if(options.map_toggle=='deaths'){\n                var country = data.country.filter(d=>d.country_code == id)[0];\n                if((!country)||(country.length==0)) return false;\n                mapTooltip.select('#map_tooltip_val tspan').text(addCommas(Math.round(country.cumulative_deaths_per_100k))+' deaths per 100k');\n            }\n    \n            if(options.map_toggle=='bi-weekly-change'){\n                var country = data.country.filter(d=>d.country_code == id);\n                if((!country)||(country.length==0)) return false;\n                var val = ((country[0].percent_change)*100).toFixed(1);\n                var str = '';\n                if(val>=0){\n                    str = '% increase';\n                } else {\n                    str = '% decrease';\n                }\n                mapTooltip.select('#map_tooltip_val tspan').text(Math.abs(val)+str);\n            }\n    \n            if(options.map_toggle=='percent-fully-vaccinated'){\n                var country = data.country.filter(d=>d.country_code == id);\n                if((!country)||(country.length==0)) return false;\n                var val = parseFloat(country[0].people_fully_vaccinated_per_hundred).toFixed(1)\n                if(isNaN(val)){ val = '-' } else { val = val + '% fully vaccinated'}\n                mapTooltip.select('#map_tooltip_val tspan').text(val);\n            }\n    \n            if(options.map_toggle=='percent-vaccine-acceptance'){\n                var country = data.country.filter(d=>d.country_code == id);\n                if((!country)||(country.length==0)) return false;\n                var val = parseFloat(country[0].vaccine_acceptance_percent).toFixed(1)\n                if(isNaN(val)){ val = '-' } else { val = val + '% vaccine acceptance'}\n                mapTooltip.select('#map_tooltip_val tspan').text(val);\n            }\n    \n            var str = mapTooltip.select('#map_tooltip_val tspan').text();\n            if(str.includes('NaN')) mapTooltip.attr('display', 'none')\n\n            d3.select('#map_tooltip_bg').attr('width', 20)\n            var bbox = d3.select('#map_tooltip_text').node().getBBox();\n            d3.select('#map_tooltip_bg').attr('width', (parseFloat(bbox.width)+15))\n            var scale = window.innerWidth/1329;\n            mapTooltip\n            .attr('display', 'inline')\n            .attr('transform', 'translate('+(e.point.x+20)+','+e.point.y+')scale('+scale+')');\n            var heightOffset = mapTooltip.node().getBBox();\n\n            if(mapTooltip.select('#map_tooltip_name tspan').text().length==0){\n                mapTooltip\n                .attr('display', 'none');\n            };\n\n            // mapTooltip.attr('transform', 'translate('+(project(([d.lng, d.lat])).x+3)+','+(project(([d.lng, d.lat])).y+2-heightOffset.height/2)+')scale('+scale+')');\n        } else {\n            mapTooltip.attr('display', 'none')\n        }\n    })\n\n\n    // function render() {\n    //     dots\n    //       .attr(\"cx\", function(d) {\n    //         return project(([d.lng, d.lat])).x;\n    //       })\n    //       .attr(\"cy\", function(d) {\n    //         return project(([d.lng, d.lat])).y;\n    //       });\n    //   }\n\n    // map.on(\"viewreset\", render);\n    // map.on(\"move\", render);\n    // map.on(\"moveend\", render);\n    // render(); // Call once to render\n\n    // tooltips\n\n    // var mapTooltip = d3.select('#map_tooltip').attr('opacity', 1).attr('transform', 'translate(0,0)').attr('display', 'none');\n\n    // d3.selectAll('.country-map').on('mousemove', function(event, d){\n\n    //     var id = d3.select(this).attr('id').substr(12,2);\n    //     var countryfiltered = data.equity_data.filter(d=>d.country_iso2 == id);\n    //     var countryName;\n    //     if(countryfiltered[0]) countryName = countryfiltered[0].country_name;\n\n    //     mapTooltip.select('#map_tooltip_name tspan').text(countryName);\n\n    //     if(options.map_toggle=='cases'){\n    //         var country = data.country.filter(d=>d.country_code == id)[0];\n    //         if((!country)||(country.length==0)) return false;\n    //         mapTooltip.select('#map_tooltip_val tspan').text(addCommas(country[1].cumulative_cases)+' cases');\n    //     }\n\n    //     if(options.map_toggle=='deaths'){\n    //         var country = data.country.filter(d=>d.country_code == id)[0];\n    //         if((!country)||(country.length==0)) return false;\n    //         mapTooltip.select('#map_tooltip_val tspan').text(addCommas(country[1].cumulative_deaths)+' deaths');\n    //     }\n\n    //     if(options.map_toggle=='bi-weekly-change'){\n    //         var country = data.country.filter(d=>d.country_code == id)[0];\n    //         if((!country)||(country.length==0)) return false;\n    //         var val = ((country[1].percent_change)*100).toFixed(1);\n    //         var str = '';\n    //         if(val>=0){\n    //             str = '% increase';\n    //         } else {\n    //             str = '% decrease';\n    //         }\n    //         mapTooltip.select('#map_tooltip_val tspan').text(Math.abs(val)+str);\n    //     }\n\n    //     if(options.map_toggle=='percent-fully-vaccinated'){\n    //         var country = data.vGroup.filter(d=>d[1][0].country_code == id)[0][1];\n    //         if((!country)||(country.length==0)) return false;\n    //         mapTooltip.select('#map_tooltip_val tspan').text(parseFloat(country[0].people_fully_vaccinated_per_hundred).toFixed(1)+'% fully vaccinated');\n    //     }\n\n    //     if(options.map_toggle=='percent-vaccine-acceptance'){\n    //         var country = data.vGroup.filter(d=>d[1][0].country_code == id)[0][1];\n    //         if((!country)||(country.length==0)) return false;\n    //         mapTooltip.select('#map_tooltip_val tspan').text(parseFloat(country[0].vaccine_acceptance_percent).toFixed(1)+'% vaccine acceptance');\n    //     }\n\n\n    //     d3.select('#map_tooltip_bg').attr('width', 0)\n\n    //     var bbox = mapTooltip.node().getBBox();\n    //     d3.select('#map_tooltip_bg').attr('width', (parseFloat(bbox.width)+2))\n    //     var scale = window.innerWidth/1329;\n    //     mapTooltip\n    //     .attr('display', 'inline')\n    //     .attr('transform', 'translate('+project(([d.lng, d.lat])).x+','+project(([d.lng, d.lat])).y+')scale('+scale+')');\n\n    //     var heightOffset = mapTooltip.node().getBBox();\n    //     mapTooltip.attr('transform', 'translate('+(project(([d.lng, d.lat])).x+3)+','+(project(([d.lng, d.lat])).y+2-heightOffset.height/2)+')scale('+scale+')');\n\n    // }).on('mouseout', function(event){\n    //     if(event.toElement=='tspan') return false;\n    //     mapTooltip.attr('display', 'none');\n    // })\n\n    map.setLayoutProperty(\n        'countries',\n        'visibility',\n        'visible'\n    );\n\n}\n\n// function project(d) {\n//     return map.project(new mapboxgl.LngLat(d[0], d[1]));\n// }\n\nexport default createMap;\n"]},"metadata":{},"sourceType":"module"}