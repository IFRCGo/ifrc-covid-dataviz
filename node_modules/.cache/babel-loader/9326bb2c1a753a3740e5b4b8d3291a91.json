{"ast":null,"code":"import * as d3 from \"d3\";\nimport moment from 'moment';\nimport colors from './colors';\nimport { nFormatter } from './HelperFunctions';\nlet yScaleCases;\nlet yScaleDeaths;\nlet yScaleVaccines;\nlet yAxisCases;\nlet yAxisDeaths;\nlet yAxisVaccines;\nlet yScaleCasesAxis;\nlet yScaleDeathsAxis;\nlet yScaleVaccinesAxis;\nlet xScale;\nlet xAxis;\nlet xScaleAxis;\nconst regions = ['AF', 'ME', 'AP', 'EU', 'AM', 'OTH'];\nexport function drawTimechart(data, options) {\n  const groupedData = [];\n  data.who_data.forEach(function (d, i) {\n    if (!groupedData[d[options.timeline_frequency + 'Total']]) groupedData[d[options.timeline_frequency + 'Total']] = {};\n    if (options.timeline_frequency === 'day') groupedData[d[options.timeline_frequency + 'Total']].date = d.date;\n    if (options.timeline_frequency === 'week') groupedData[d[options.timeline_frequency + 'Total']].date = d.week_start;\n    if (options.timeline_frequency === 'month') groupedData[d[options.timeline_frequency + 'Total']].date = d.month_start;\n    if (!groupedData[d[options.timeline_frequency + 'Total']][d.ifrc_region]) groupedData[d[options.timeline_frequency + 'Total']][d.ifrc_region] = {\n      new_cases: 0,\n      new_deaths: 0,\n      cumulative_cases: 0,\n      cumulative_deaths: 0\n    };\n    groupedData[d[options.timeline_frequency + 'Total']][d.ifrc_region].new_cases += d.new_cases;\n    groupedData[d[options.timeline_frequency + 'Total']][d.ifrc_region].new_deaths += d.new_deaths;\n    groupedData[d[options.timeline_frequency + 'Total']][d.ifrc_region].cumulative_cases = 0;\n  }); // totals by date\n\n  groupedData.forEach(function (d, i) {\n    regions.forEach(function (dd, ii) {\n      if (!d.hasOwnProperty(dd)) {\n        d[dd] = {\n          new_cases: 0,\n          new_deaths: 0,\n          cumulative_cases: 0,\n          cumulative_deaths: 0\n        };\n      } // if(dd!=='OTH') d.region.push({'region': dd, 'new_cases': d[dd].new_cases, 'new_deaths': d[dd].new_deaths, 'cumulative_cases': d[dd].cumulative_cases, 'cumulative_deaths': d[dd].cumulative_deaths});\n\n\n      if (i > 0) {\n        d[dd].cumulative_cases = groupedData[i][dd].new_cases + groupedData[i - 1][dd].cumulative_cases;\n        d[dd].cumulative_deaths = groupedData[i][dd].new_deaths + groupedData[i - 1][dd].cumulative_deaths;\n      } else {\n        d[dd].cumulative_cases = groupedData[i][dd].new_cases;\n        d[dd].cumulative_deaths = groupedData[i][dd].new_deaths;\n      }\n    });\n    d.total_new_cases = d.AF.new_cases + d.AP.new_cases + d.AM.new_cases + d.EU.new_cases + d.ME.new_cases + d.OTH.new_cases;\n    d.total_cumulative_cases = d.AF.cumulative_cases + d.AP.cumulative_cases + d.AM.cumulative_cases + d.EU.cumulative_cases + d.ME.cumulative_cases + d.OTH.cumulative_cases;\n    d.total_new_deaths = d.AF.new_deaths + d.AP.new_deaths + d.AM.new_deaths + d.EU.new_deaths + d.ME.new_deaths + d.OTH.new_deaths;\n    d.total_cumulative_deaths = d.AF.cumulative_deaths + d.AP.cumulative_deaths + d.AM.cumulative_deaths + d.EU.cumulative_deaths + d.ME.cumulative_deaths + d.OTH.cumulative_deaths;\n    d.region = [];\n    regions.forEach(function (dd, ii) {\n      d.region.push({\n        'region': dd,\n        'new_cases': d[dd].new_cases,\n        'new_deaths': d[dd].new_deaths,\n        'cumulative_cases': d[dd].cumulative_cases,\n        'cumulative_deaths': d[dd].cumulative_deaths\n      });\n    });\n  });\n  let vgroupedData = [];\n\n  if (options.timeline_type != 'cumulative') {\n    // cumulative and stacked\n    data.vaccines_data = data.vaccines_data_daily;\n    data.vaccines_data.forEach(function (d, i) {\n      if (!vgroupedData[d[options.timeline_frequency + 'Total']]) vgroupedData[d[options.timeline_frequency + 'Total']] = {};\n      if (options.timeline_frequency === 'day') vgroupedData[d[options.timeline_frequency + 'Total']].date = d.date;\n      if (options.timeline_frequency === 'week') vgroupedData[d[options.timeline_frequency + 'Total']].date = d.week_start;\n      if (options.timeline_frequency === 'month') vgroupedData[d[options.timeline_frequency + 'Total']].date = d.month_start;\n      if (!vgroupedData[d[options.timeline_frequency + 'Total']][d.ifrc_region]) vgroupedData[d[options.timeline_frequency + 'Total']][d.ifrc_region] = {\n        new_vaccines: 0\n      };\n      vgroupedData[d[options.timeline_frequency + 'Total']][d.ifrc_region].new_vaccines += d.daily_vaccinations;\n    }); // totals by date\n\n    vgroupedData.forEach(function (d, i) {\n      regions.forEach(function (dd, ii) {\n        if (!d[dd]) {\n          d[dd] = {\n            new_vaccines: 0,\n            cumulative_vaccines: 0\n          };\n        }\n      });\n      d.total_new_vaccines = d.AF.new_vaccines + d.AP.new_vaccines + d.AM.new_vaccines + d.EU.new_vaccines + d.ME.new_vaccines + d.OTH.new_vaccines;\n      d.region = [];\n      regions.forEach(function (dd, ii) {\n        d.region.push({\n          'region': dd,\n          'new_vaccines': d[dd].new_vaccines\n        });\n      });\n    });\n  } else {\n    // cumulative only\n    data.vaccines_data = [];\n\n    if (options.timeline_frequency === 'day') {\n      data.vaccines_data = data.vaccines_data_cumulative;\n    }\n\n    if (options.timeline_frequency === 'week') {\n      data.vaccines_data_cumulative.forEach(function (d, i) {\n        var endOfWeekDate = moment(d.date).endOf('isoWeek').startOf('day').unix();\n        var date = moment(d.date).startOf('day').unix();\n\n        if (date == endOfWeekDate || d.date == options.maxDate) {\n          data.vaccines_data.push(d);\n        }\n      });\n    }\n\n    if (options.timeline_frequency === 'month') {\n      var maxDateUnix = moment(options.maxDate).startOf('day').unix();\n      data.vaccines_data_cumulative.forEach(function (d, i) {\n        var endOfMonthDate = moment(d.date).endOf('month').startOf('day').unix();\n        var date = moment(d.date).startOf('day').unix();\n\n        if (date == endOfMonthDate || options.maxDate != endOfMonthDate && date == maxDateUnix) {\n          data.vaccines_data.push(d);\n        }\n      });\n    }\n\n    data.vaccines_data.forEach(function (d, i) {\n      if (!vgroupedData[d[options.timeline_frequency + 'Total']]) vgroupedData[d[options.timeline_frequency + 'Total']] = {};\n      if (options.timeline_frequency === 'day') vgroupedData[d[options.timeline_frequency + 'Total']].date = d.date;\n      if (options.timeline_frequency === 'week') vgroupedData[d[options.timeline_frequency + 'Total']].date = d.week_start;\n      if (options.timeline_frequency === 'month') vgroupedData[d[options.timeline_frequency + 'Total']].date = d.month_start;\n      if (!vgroupedData[d[options.timeline_frequency + 'Total']][d.ifrc_region]) vgroupedData[d[options.timeline_frequency + 'Total']][d.ifrc_region] = {\n        cumulative_vaccines: 0\n      };\n      vgroupedData[d[options.timeline_frequency + 'Total']][d.ifrc_region].cumulative_vaccines += d.total_vaccinations;\n    }); // totals by date\n\n    vgroupedData.forEach(function (d, i) {\n      regions.forEach(function (dd, ii) {\n        if (!d[dd]) {\n          d[dd] = {\n            cumulative_vaccines: 0\n          };\n        }\n      });\n      d.total_cumulative_vaccines = d.AF.cumulative_vaccines + d.AP.cumulative_vaccines + d.AM.cumulative_vaccines + d.EU.cumulative_vaccines + d.ME.cumulative_vaccines + d.OTH.cumulative_vaccines;\n      d.region = [];\n      regions.forEach(function (dd, ii) {\n        d.region.push({\n          'region': dd,\n          'cumulative_vaccines': d[dd].cumulative_vaccines\n        });\n      });\n    });\n  }\n\n  vgroupedData = vgroupedData.filter(function (el) {\n    return el;\n  });\n  const numIntervals = d3.max(data.who_data, function (d, i) {\n    return d[options.timeline_frequency + 'Total'];\n  });\n  const maxCases = d3.max(groupedData, function (d, i) {\n    if (options.timeline_type === 'non-cumulative') return d.total_new_cases;\n    if (options.timeline_type === 'cumulative') return d.total_cumulative_cases;\n    if (options.timeline_type === 'stacked') return 100;\n  });\n  const maxDeaths = d3.max(groupedData, function (d, i) {\n    if (options.timeline_type === 'non-cumulative') return d.total_new_deaths;\n    if (options.timeline_type === 'cumulative') return d.total_cumulative_deaths;\n    if (options.timeline_type === 'stacked') return 100;\n  });\n  const maxVaccines = d3.max(vgroupedData, function (d, i) {\n    if (d) {\n      if (options.timeline_type === 'non-cumulative') return d.total_new_vaccines;\n      if (options.timeline_type === 'cumulative') return d.total_cumulative_vaccines;\n      if (options.timeline_type === 'stacked') return 100;\n    }\n  }); // define date range\n  // const minDate = groupedData[0].date;\n  // const maxDate = groupedData[numIntervals].date;\n\n  const minDate = groupedData[0].date;\n  const maxDate = options.maxDate;\n  let md = moment(maxDate);\n  if (options.timeline_frequency === 'month') md = md.add(1, 'months');\n  if (options.timeline_frequency === 'week') md = md.add(1, 'weeks');\n  if (options.timeline_frequency === 'day') md = md.add(1, 'days');\n  const svg = d3.select('#timechart_svg');\n  svg.selectAll('g').remove();\n  d3.selectAll('#layout .yAxis').remove();\n  d3.selectAll('#yAxis').remove();\n  d3.selectAll('#layout .xAxis').remove(); //bg\n\n  svg.append('g').append('rect').attr('width', '100%').attr('height', '100%').attr('x', 0).attr('y', 0).attr('fill', '#FFF').attr('opacity', 0);\n  const width = 2000;\n  const barWidth = width / numIntervals;\n  let barSpacing = 0.04;\n  if (options.timeline_frequency === 'month') barSpacing = 0.03;\n  if (options.timeline_frequency === 'day') barSpacing = 0; // define scales\n\n  xScale = d3.scaleTime().range([0, width]).domain([minDate, md]);\n  xScaleAxis = d3.scaleTime().range([0, 596]).domain([minDate, md]); // xScaleAxis = d3.scaleTime()\n  // .range([35,596])\n  // .domain([minDate,maxDate]);\n\n  yScaleCases = d3.scaleLinear().range([0, 140]).domain([0, maxCases]);\n  yScaleCasesAxis = d3.scaleLinear().range([140, 0]).domain([0, maxCases]);\n  yScaleDeaths = d3.scaleLinear().range([0, 140]).domain([0, maxDeaths]);\n  yScaleDeathsAxis = d3.scaleLinear().range([140, 0]).domain([0, maxDeaths]);\n  yScaleVaccines = d3.scaleLinear().range([0, 140]).domain([0, maxVaccines]);\n  yScaleVaccinesAxis = d3.scaleLinear().range([140, 0]).domain([0, maxVaccines]); // define axi\n\n  xAxis = d3.axisBottom().scale(xScaleAxis).tickSize(2).tickPadding(3); // if(options.timeline_frequency=='month')\n  // xAxis.ticks(d3.timeMonth.every(3)).tickFormat(d3.timeFormat(\"%b %Y\"));\n  // if(options.timeline_frequency=='week')\n  // xAxis.ticks(d3.timeWeek.every(10)).tickFormat(d3.timeFormat(\"%d %b %Y\"));\n\n  yAxisCases = d3.axisRight().scale(yScaleCasesAxis).ticks(3).tickSize(3).tickPadding(3).tickFormat(function (d) {\n    if (options.timeline_type == 'stacked') return nFormatter(d) + '%';\n    return nFormatter(d);\n  });\n  yAxisDeaths = d3.axisRight().scale(yScaleDeathsAxis).ticks(3).tickSize(3).tickPadding(3).tickFormat(function (d) {\n    if (options.timeline_type == 'stacked') return nFormatter(d) + '%';\n    return nFormatter(d);\n  });\n  yAxisVaccines = d3.axisRight().scale(yScaleVaccinesAxis).ticks(3).tickSize(3).tickPadding(3).tickFormat(function (d) {\n    if (options.timeline_type == 'stacked') return nFormatter(d) + '%';\n    return nFormatter(d);\n  }); // y-axis cases\n\n  var yAxisGroup = d3.select('#layout').append(\"g\").attr('id', 'yAxis').attr('clip-path', 'url(#mask)');\n  var yAxisCasesText = yAxisGroup.append(\"g\").attr(\"class\", \"yAxis axis\").attr(\"id\", \"casesAxis\").attr('transform', 'translate(620,363)').call(yAxisCases); // y-axis deaths\n\n  var yAxisDeathsText = yAxisGroup.append(\"g\").attr(\"class\", \"yAxis axis\").attr(\"id\", \"deathsAxis\").attr('transform', 'translate(620,534)').call(yAxisDeaths); // y-axis vaccines\n\n  var yAxisVaccinesText = yAxisGroup.append(\"g\").attr(\"class\", \"yAxis axis\").attr(\"id\", \"VaccinesAxis\").attr('transform', 'translate(620,707.5)').call(yAxisVaccines); // x-axis cases\n\n  var xAxisCases = yAxisGroup.append('g').attr(\"id\", \"casesXAxis\").attr('class', 'xAxis').attr('transform', 'translate(24,504)').call(xAxis);\n  var xAxisDeaths = yAxisGroup.append('g').attr(\"id\", \"deathsXAxis\").attr('class', 'xAxis').attr('transform', 'translate(24,674)').call(xAxis);\n  var xAxisVaccines = yAxisGroup.append('g').attr(\"id\", \"vaccinesXAxis\").attr('class', 'xAxis').attr('transform', 'translate(24,848)').call(xAxis);\n  var xAxisTimeline = yAxisGroup.append('g').attr(\"id\", \"timelineXAxis\").attr('class', 'xAxis').attr('transform', 'translate(24,908)').call(xAxis); // CASES\n  // loop through groupedData and draw bars\n\n  const barGroups = svg.selectAll('.bar_group').data(groupedData).enter().append('g').attr('class', 'bar_group').attr('data-date', function (d) {\n    return d.date;\n  }).attr('transform', function (d, i) {\n    return 'translate(' + xScale(d.date) + ')';\n  }); // CASES\n\n  barGroups.selectAll('.cases_bar').data(function (d, i) {\n    return d.region.filter(function (dd, ii) {\n      return dd.region !== 'OTH';\n    });\n  }).enter().append('rect').attr('class', function (d, i) {\n    return 'timeBar cases_bar time_' + d.region;\n  }).attr('x', barWidth * barSpacing).attr('y', function (d, i) {\n    const totalNewCases = d3.select(this.parentNode).datum().total_new_cases - d3.select(this.parentNode).datum().OTH.new_cases;\n    let dp = 0;\n\n    if (i > 0) {\n      for (let ii = 1; ii <= i; ii++) {\n        if (options.timeline_type === 'cumulative') dp += d3.select(this.parentNode).datum().region[ii - 1].cumulative_cases;\n        if (options.timeline_type === 'non-cumulative') dp += d3.select(this.parentNode).datum().region[ii - 1].new_cases;\n        if (options.timeline_type === 'stacked') dp += d3.select(this.parentNode).datum().region[ii - 1].new_cases;\n      }\n    }\n\n    let y = 0;\n    if (options.timeline_type === 'cumulative') y = 140 - yScaleCases(d.cumulative_cases) - yScaleCases(dp);\n    if (options.timeline_type === 'non-cumulative') y = 140 - yScaleCases(d.new_cases) - yScaleCases(dp);\n    if (options.timeline_type === 'stacked') y = 140 - 140 * (d.new_cases / totalNewCases) - 140 * (dp / totalNewCases);\n\n    if (y) {\n      if (y > 0) {\n        return y;\n      } else {\n        return 0;\n      }\n\n      ;\n    } else {\n      return 0;\n    }\n\n    ;\n  }).attr('width', barWidth - barWidth * barSpacing * 2).attr('height', function (d, i) {\n    const totalNewCases = d3.select(this.parentNode).datum().total_new_cases - d3.select(this.parentNode).datum().OTH.new_cases;\n    let y = 0;\n    if (options.timeline_type === 'cumulative') y = yScaleCases(d.cumulative_cases);\n    if (options.timeline_type === 'non-cumulative') y = yScaleCases(d.new_cases);\n    if (options.timeline_type === 'stacked') y = 140 * (d.new_cases / totalNewCases);\n\n    if (y) {\n      if (y > 0) {\n        return y;\n      } else {\n        return 0;\n      }\n\n      ;\n    } else {\n      return 0;\n    }\n\n    ;\n  }).attr('fill', function (d, i) {\n    return colors.regions[d.region];\n  }); // DEATHS\n\n  barGroups.selectAll('.deaths_bar').data(function (d, i) {\n    return d.region.filter(function (dd, ii) {\n      return dd.region !== 'OTH';\n    });\n  }).enter().append('rect').attr('class', function (d, i) {\n    return 'timeBar deaths_bar time_' + d.region;\n  }).attr('x', barWidth * barSpacing).attr('y', function (d, i) {\n    const totalNewDeaths = d3.select(this.parentNode).datum().total_new_deaths - d3.select(this.parentNode).datum().OTH.new_deaths;\n    let dp = 0;\n\n    if (i > 0) {\n      for (let ii = 1; ii <= i; ii++) {\n        if (options.timeline_type === 'cumulative') dp += d3.select(this.parentNode).datum().region[ii - 1].cumulative_deaths;\n        if (options.timeline_type === 'non-cumulative') dp += d3.select(this.parentNode).datum().region[ii - 1].new_deaths;\n        if (options.timeline_type === 'stacked') dp += d3.select(this.parentNode).datum().region[ii - 1].new_deaths;\n      }\n    }\n\n    let y = 0;\n    if (options.timeline_type === 'cumulative') y = 140 - yScaleDeaths(d.cumulative_deaths) - yScaleDeaths(dp) + 170;\n    if (options.timeline_type === 'non-cumulative') y = 140 - yScaleDeaths(d.new_deaths) - yScaleDeaths(dp) + 170;\n    if (options.timeline_type === 'stacked') y = 140 - 140 * (d.new_deaths / totalNewDeaths) - 140 * (dp / totalNewDeaths) + 170;\n\n    if (y) {\n      if (y > 0) {\n        return y;\n      } else {\n        return 0;\n      }\n\n      ;\n    } else {\n      return 0;\n    }\n\n    ;\n  }).attr('width', barWidth - barWidth * barSpacing * 2).attr('height', function (d, i) {\n    const totalNewDeaths = d3.select(this.parentNode).datum().total_new_deaths - d3.select(this.parentNode).datum().OTH.new_deaths;\n    let y = 0;\n    if (options.timeline_type === 'cumulative') y = yScaleDeaths(d.cumulative_deaths);\n    if (options.timeline_type === 'non-cumulative') y = yScaleDeaths(d.new_deaths);\n    if (options.timeline_type === 'stacked') y = 140 * (d.new_deaths / totalNewDeaths);\n\n    if (y) {\n      if (y > 0) {\n        return y;\n      } else {\n        return 0;\n      }\n\n      ;\n    } else {\n      return 0;\n    }\n\n    ;\n  }).attr('fill', function (d, i) {\n    return colors.regions[d.region];\n  }); // bar size tweak for spacing\n\n  if (options.timeline_frequency === 'month') {\n    barGroups.selectAll(\".timeBar\").attr(\"width\", function (d) {\n      var date = d3.select(this.parentNode).datum().date;\n      var next = d3.timeMonth.offset(date, 1);\n      return (xScale(next) - xScale(date)) * (1 - barSpacing);\n    }).attr(\"x\", function (d) {\n      var date = d3.select(this.parentNode).datum().date;\n      var next = d3.timeMonth.offset(date, 1);\n      return (xScale(next) - xScale(date)) * (barSpacing / 2);\n    });\n  } // VACCINES\n\n\n  const vbarGroups = svg.selectAll('.vbar_group').data(vgroupedData).enter().append('g').attr('class', 'vbar_group').attr('data-date', function (d) {\n    return d.date;\n  }).attr('transform', function (d, i) {\n    return 'translate(' + xScale(d.date) + ', 344)';\n  });\n  vbarGroups.selectAll('.vaccines_bar').data(function (d, i) {\n    return d.region.filter(function (dd, ii) {\n      return dd.region !== 'OTH';\n    });\n  }).enter().append('rect').attr('class', 'timeBar vaccines_bar').attr('class', function (d, i) {\n    return 'timeBar vaccines_bar time_' + d.region;\n  }).attr('x', barWidth * barSpacing).attr('y', function (d, i) {\n    const totalNewVaccines = d3.select(this.parentNode).datum().total_new_vaccines - d3.select(this.parentNode).datum().OTH.new_vaccines;\n    let dp = 0;\n\n    if (i > 0) {\n      for (let ii = 1; ii <= i; ii++) {\n        if (options.timeline_type === 'cumulative') dp += d3.select(this.parentNode).datum().region[ii - 1].cumulative_vaccines;\n        if (options.timeline_type === 'non-cumulative') dp += d3.select(this.parentNode).datum().region[ii - 1].new_vaccines;\n        if (options.timeline_type === 'stacked') dp += d3.select(this.parentNode).datum().region[ii - 1].new_vaccines;\n      }\n    }\n\n    let y = 0;\n    if (options.timeline_type === 'cumulative') y = 140 - yScaleVaccines(d.cumulative_vaccines) - yScaleVaccines(dp);\n    if (options.timeline_type === 'non-cumulative') y = 140 - yScaleVaccines(d.new_vaccines) - yScaleVaccines(dp);\n    if (options.timeline_type === 'stacked') y = 140 - 140 * (d.new_vaccines / totalNewVaccines) - 140 * (dp / totalNewVaccines);\n\n    if (y) {\n      if (y > 0) {\n        return y;\n      } else {\n        return 0;\n      }\n\n      ;\n    } else {\n      return 0;\n    }\n\n    ;\n  }).attr('width', barWidth - barWidth * barSpacing * 2).attr('height', function (d, i) {\n    const totalNewVaccines = d3.select(this.parentNode).datum().total_new_vaccines - d3.select(this.parentNode).datum().OTH.new_vaccines;\n    let y = 0;\n    if (options.timeline_type === 'cumulative') y = yScaleVaccines(d.cumulative_vaccines);\n    if (options.timeline_type === 'non-cumulative') y = yScaleVaccines(d.new_vaccines);\n    if (options.timeline_type === 'stacked') y = 140 * (d.new_vaccines / totalNewVaccines);\n\n    if (y) {\n      if (y > 0) {\n        return y;\n      } else {\n        return 0;\n      }\n\n      ;\n    } else {\n      return 0;\n    }\n\n    ;\n  }).attr('fill', function (d, i) {\n    return colors.regions[d.region];\n  });\n\n  if (options.timeline_frequency === 'month') {\n    vbarGroups.selectAll(\".timeBar\").attr(\"width\", function (d) {\n      var date = d3.select(this.parentNode).datum().date;\n      var next = d3.timeMonth.offset(date, 1);\n      return (xScale(next) - xScale(date)) * (1 - barSpacing);\n    }).attr(\"x\", function (d) {\n      var date = d3.select(this.parentNode).datum().date;\n      var next = d3.timeMonth.offset(date, 1);\n      return (xScale(next) - xScale(date)) * (barSpacing / 2);\n    });\n  } // bar size tweak for spacing\n\n\n  if (options.timeline_frequency === 'month') {\n    barGroups.selectAll(\".timeBar\").attr(\"width\", function (d) {\n      var date = d3.select(this.parentNode).datum().date;\n      var next = d3.timeMonth.offset(date, 1);\n      return (xScale(next) - xScale(date)) * (1 - barSpacing);\n    }).attr(\"x\", function (d) {\n      var date = d3.select(this.parentNode).datum().date;\n      var next = d3.timeMonth.offset(date, 1);\n      return (xScale(next) - xScale(date)) * (barSpacing / 2);\n    });\n  } // hover bar\n\n\n  var hoverBar = svg.append('rect').attr('id', 'timechart_hover').attr('width', barWidth).attr('x', 0).attr('y', 0).attr('opacity', 0).attr('height', '100%').attr('fill', 'rgb(221 221 221 / 40%)');\n  svg.on('mouseover', function (d, i) {\n    hoverBar.attr('opacity', 1);\n  }).on('mouseout', function (d, i) {\n    hoverBar.attr('opacity', 0);\n  }).on('mousemove', event => {\n    var coords = d3.pointer(event);\n    var xDate = xScale.invert(coords[0]);\n    if (options.timeline_frequency == 'week') xDate = moment(xDate).startOf('isoWeek');\n    if (options.timeline_frequency == 'day') xDate = moment(xDate).startOf('day');\n    if (options.timeline_frequency == 'month') xDate = moment(xDate).startOf('month');\n    hoverBar.attr('x', xScale(xDate.toDate()));\n\n    if (xScale(xDate.toDate() > options.maxDate)) {\n      hoverBar.attr('opacity', 0);\n    } else {\n      hoverBar.attr('opacity', 1);\n    }\n  });\n}\nexport function updateTimechart(data, options) {\n  const groupedData = [];\n  data.who_data.forEach(function (d, i) {\n    if (!groupedData[d[options.timeline_frequency + 'Total']]) groupedData[d[options.timeline_frequency + 'Total']] = {};\n    if (options.timeline_frequency === 'day') groupedData[d[options.timeline_frequency + 'Total']].date = d.date;\n    if (options.timeline_frequency === 'week') groupedData[d[options.timeline_frequency + 'Total']].date = d.week_start;\n    if (options.timeline_frequency === 'month') groupedData[d[options.timeline_frequency + 'Total']].date = d.month_start;\n    if (!groupedData[d[options.timeline_frequency + 'Total']][d.ifrc_region]) groupedData[d[options.timeline_frequency + 'Total']][d.ifrc_region] = {\n      new_cases: 0,\n      new_deaths: 0,\n      cumulative_cases: 0,\n      cumulative_deaths: 0\n    };\n    groupedData[d[options.timeline_frequency + 'Total']][d.ifrc_region].new_cases += d.new_cases;\n    groupedData[d[options.timeline_frequency + 'Total']][d.ifrc_region].new_deaths += d.new_deaths;\n    groupedData[d[options.timeline_frequency + 'Total']][d.ifrc_region].cumulative_cases = 0;\n  }); // totals by date\n\n  groupedData.forEach(function (d, i) {\n    regions.forEach(function (dd, ii) {\n      if (!d.hasOwnProperty(dd)) {\n        d[dd] = {\n          new_cases: 0,\n          new_deaths: 0,\n          cumulative_cases: 0,\n          cumulative_deaths: 0\n        };\n      } // if(dd!=='OTH') d.region.push({'region': dd, 'new_cases': d[dd].new_cases, 'new_deaths': d[dd].new_deaths, 'cumulative_cases': d[dd].cumulative_cases, 'cumulative_deaths': d[dd].cumulative_deaths});\n\n\n      if (i > 0) {\n        d[dd].cumulative_cases = groupedData[i][dd].new_cases + groupedData[i - 1][dd].cumulative_cases;\n        d[dd].cumulative_deaths = groupedData[i][dd].new_deaths + groupedData[i - 1][dd].cumulative_deaths;\n      } else {\n        d[dd].cumulative_cases = groupedData[i][dd].new_cases;\n        d[dd].cumulative_deaths = groupedData[i][dd].new_deaths;\n      }\n    });\n    d.total_new_cases = d.AF.new_cases + d.AP.new_cases + d.AM.new_cases + d.EU.new_cases + d.ME.new_cases + d.OTH.new_cases;\n    d.total_cumulative_cases = d.AF.cumulative_cases + d.AP.cumulative_cases + d.AM.cumulative_cases + d.EU.cumulative_cases + d.ME.cumulative_cases + d.OTH.cumulative_cases;\n    d.total_new_deaths = d.AF.new_deaths + d.AP.new_deaths + d.AM.new_deaths + d.EU.new_deaths + d.ME.new_deaths + d.OTH.new_deaths;\n    d.total_cumulative_deaths = d.AF.cumulative_deaths + d.AP.cumulative_deaths + d.AM.cumulative_deaths + d.EU.cumulative_deaths + d.ME.cumulative_deaths + d.OTH.cumulative_deaths;\n    d.region = [];\n    regions.forEach(function (dd, ii) {\n      d.region.push({\n        'region': dd,\n        'new_cases': d[dd].new_cases,\n        'new_deaths': d[dd].new_deaths,\n        'cumulative_cases': d[dd].cumulative_cases,\n        'cumulative_deaths': d[dd].cumulative_deaths\n      });\n    });\n  });\n  let vgroupedData = [];\n\n  if (options.timeline_type != 'cumulative') {\n    // cumulative and stacked\n    data.vaccines_data = data.vaccines_data_daily;\n    data.vaccines_data.forEach(function (d, i) {\n      if (!vgroupedData[d[options.timeline_frequency + 'Total']]) vgroupedData[d[options.timeline_frequency + 'Total']] = {};\n      if (options.timeline_frequency === 'day') vgroupedData[d[options.timeline_frequency + 'Total']].date = d.date;\n      if (options.timeline_frequency === 'week') vgroupedData[d[options.timeline_frequency + 'Total']].date = moment(d.date).startOf('isoWeek').toDate();\n      if (options.timeline_frequency === 'month') vgroupedData[d[options.timeline_frequency + 'Total']].date = moment(d.date).startOf('month').toDate();\n      if (!vgroupedData[d[options.timeline_frequency + 'Total']][d.ifrc_region]) vgroupedData[d[options.timeline_frequency + 'Total']][d.ifrc_region] = {\n        new_vaccines: 0\n      };\n      vgroupedData[d[options.timeline_frequency + 'Total']][d.ifrc_region].new_vaccines += d.daily_vaccinations;\n    }); // totals by date\n\n    vgroupedData.forEach(function (d, i) {\n      regions.forEach(function (dd, ii) {\n        if (!d[dd]) {\n          d[dd] = {\n            new_vaccines: 0,\n            cumulative_vaccines: 0\n          };\n        }\n      });\n      d.total_new_vaccines = d.AF.new_vaccines + d.AP.new_vaccines + d.AM.new_vaccines + d.EU.new_vaccines + d.ME.new_vaccines + d.OTH.new_vaccines;\n      d.region = [];\n      regions.forEach(function (dd, ii) {\n        d.region.push({\n          'region': dd,\n          'new_vaccines': d[dd].new_vaccines\n        });\n      });\n    });\n  } else {\n    // cumulative only\n    data.vaccines_data = [];\n\n    if (options.timeline_frequency === 'day') {\n      data.vaccines_data = data.vaccines_data_cumulative;\n    }\n\n    if (options.timeline_frequency === 'week') {\n      data.vaccines_data_cumulative.forEach(function (d, i) {\n        var endOfWeekDate = moment(d.date).endOf('isoWeek').startOf('day').unix();\n        var date = moment(d.date).startOf('day').unix();\n\n        if (date == endOfWeekDate || d.date == options.maxDate) {\n          data.vaccines_data.push(d);\n        }\n      });\n    }\n\n    if (options.timeline_frequency === 'month') {\n      var maxDateUnix = moment(options.maxDate).startOf('day').unix();\n      data.vaccines_data_cumulative.forEach(function (d, i) {\n        var endOfMonthDate = moment(d.date).endOf('month').startOf('day').unix();\n        var date = moment(d.date).startOf('day').unix();\n\n        if (date == endOfMonthDate || options.maxDate != endOfMonthDate && date == maxDateUnix) {\n          data.vaccines_data.push(d);\n        }\n      });\n    }\n\n    data.vaccines_data.forEach(function (d, i) {\n      if (!vgroupedData[d[options.timeline_frequency + 'Total']]) vgroupedData[d[options.timeline_frequency + 'Total']] = {};\n      if (options.timeline_frequency === 'day') vgroupedData[d[options.timeline_frequency + 'Total']].date = d.date;\n      if (options.timeline_frequency === 'week') vgroupedData[d[options.timeline_frequency + 'Total']].date = moment(d.date).startOf('isoWeek').toDate();\n      if (options.timeline_frequency === 'month') vgroupedData[d[options.timeline_frequency + 'Total']].date = moment(d.date).startOf('month').toDate();\n      if (!vgroupedData[d[options.timeline_frequency + 'Total']][d.ifrc_region]) vgroupedData[d[options.timeline_frequency + 'Total']][d.ifrc_region] = {\n        cumulative_vaccines: 0\n      };\n      vgroupedData[d[options.timeline_frequency + 'Total']][d.ifrc_region].cumulative_vaccines += d.total_vaccinations;\n    }); // totals by date\n\n    vgroupedData.forEach(function (d, i) {\n      regions.forEach(function (dd, ii) {\n        if (!d[dd]) {\n          d[dd] = {\n            cumulative_vaccines: 0\n          };\n        }\n      });\n      d.total_cumulative_vaccines = d.AF.cumulative_vaccines + d.AP.cumulative_vaccines + d.AM.cumulative_vaccines + d.EU.cumulative_vaccines + d.ME.cumulative_vaccines + d.OTH.cumulative_vaccines;\n      d.region = [];\n      regions.forEach(function (dd, ii) {\n        d.region.push({\n          'region': dd,\n          'cumulative_vaccines': d[dd].cumulative_vaccines\n        });\n      });\n    });\n  }\n\n  vgroupedData = vgroupedData.filter(function (el) {\n    return el;\n  });\n  const numIntervals = d3.max(data.who_data, function (d, i) {\n    return d[options.timeline_frequency + 'Total'];\n  });\n  const maxCases = d3.max(groupedData, function (d, i) {\n    if (options.timeline_type === 'non-cumulative') return d.total_new_cases;\n    if (options.timeline_type === 'cumulative') return d.total_cumulative_cases;\n    if (options.timeline_type === 'stacked') return 100;\n  });\n  const maxDeaths = d3.max(groupedData, function (d, i) {\n    if (options.timeline_type === 'non-cumulative') return d.total_new_deaths;\n    if (options.timeline_type === 'cumulative') return d.total_cumulative_deaths;\n    if (options.timeline_type === 'stacked') return 100;\n  });\n  const maxVaccines = d3.max(vgroupedData, function (d, i) {\n    if (d) {\n      if (options.timeline_type === 'non-cumulative') return d.total_new_vaccines;\n      if (options.timeline_type === 'cumulative') return d.total_cumulative_vaccines;\n      if (options.timeline_type === 'stacked') return 100;\n    }\n  }); // define date range\n  // const minDate = groupedData[0].date;\n  // const maxDate = groupedData[numIntervals].date;\n\n  let minDate;\n\n  if (groupedData.length > 0) {\n    minDate = groupedData[0].date;\n  } else {\n    minDate = options.minDate;\n  }\n\n  const maxDate = options.maxDate;\n  let md = moment(maxDate);\n  if (options.timeline_frequency === 'month') md = md.add(1, 'months');\n  if (options.timeline_frequency === 'week') md = md.add(1, 'weeks');\n  if (options.timeline_frequency === 'day') md = md.add(1, 'days');\n  const svg = d3.select('#timechart_svg');\n  const width = 2000;\n  const barWidth = width / numIntervals;\n  let barSpacing = 0.04;\n  if (options.timeline_frequency === 'month') barSpacing = 0.03;\n  if (options.timeline_frequency === 'day') barSpacing = 0; // define scales\n\n  xScale = d3.scaleTime().range([0, width]).domain([minDate, md]);\n  xScaleAxis = d3.scaleTime().range([23, 596]).domain([minDate, md]);\n  yScaleCases = d3.scaleLinear().range([0, 140]).domain([0, maxCases]);\n  yScaleCasesAxis = d3.scaleLinear().range([140, 0]).domain([0, maxCases]);\n  yScaleDeaths = d3.scaleLinear().range([0, 140]).domain([0, maxDeaths]);\n  yScaleDeathsAxis = d3.scaleLinear().range([140, 0]).domain([0, maxDeaths]);\n  yScaleVaccines = d3.scaleLinear().range([0, 140]).domain([0, maxVaccines]);\n  yScaleVaccinesAxis = d3.scaleLinear().range([140, 0]).domain([0, maxVaccines]); // define axi\n\n  yAxisCases = d3.axisRight().scale(yScaleCasesAxis).ticks(3).tickSize(3).tickPadding(3).tickFormat(function (d) {\n    if (options.timeline_type == 'stacked') return nFormatter(d) + '%';\n    return nFormatter(d);\n  });\n  yAxisDeaths = d3.axisRight().scale(yScaleDeathsAxis).ticks(3).tickSize(3).tickPadding(3).tickFormat(function (d) {\n    if (options.timeline_type == 'stacked') return nFormatter(d) + '%';\n    return nFormatter(d);\n  });\n  yAxisVaccines = d3.axisRight().scale(yScaleVaccinesAxis).ticks(3).tickSize(3).tickPadding(3).tickFormat(function (d) {\n    if (options.timeline_type == 'stacked') return nFormatter(d) + '%';\n    return nFormatter(d);\n  }); // y-axis cases\n\n  var yAxisCasesText = d3.select('#casesAxis').transition().duration(500).call(yAxisCases); // y-axis deaths\n\n  var yAxisDeathsText = d3.select('#deathsAxis').transition().duration(500).call(yAxisDeaths); // y-axis vaccines\n\n  var yAxisVaccinesText = d3.select('#VaccinesAxis').transition().duration(500).call(yAxisVaccines); // CASES\n  // loop through groupedData and draw bars\n\n  const barGroups = svg.selectAll('.bar_group').data(groupedData).attr('data-date', function (d) {\n    return d.date;\n  }).attr('transform', function (d, i) {\n    return 'translate(' + xScale(d.date) + ')';\n  }); // CASES\n\n  barGroups.selectAll('.cases_bar').data(function (d, i) {\n    return d.region.filter(function (dd, ii) {\n      return dd.region !== 'OTH';\n    });\n  }).transition().duration(500).attr('y', function (d, i) {\n    const totalNewCases = d3.select(this.parentNode).datum().total_new_cases - d3.select(this.parentNode).datum().OTH.new_cases;\n    let dp = 0;\n\n    if (i > 0) {\n      for (let ii = 1; ii <= i; ii++) {\n        if (options.timeline_type === 'cumulative') dp += d3.select(this.parentNode).datum().region[ii - 1].cumulative_cases;\n        if (options.timeline_type === 'non-cumulative') dp += d3.select(this.parentNode).datum().region[ii - 1].new_cases;\n        if (options.timeline_type === 'stacked') dp += d3.select(this.parentNode).datum().region[ii - 1].new_cases;\n      }\n    }\n\n    let y = 0;\n    if (options.timeline_type === 'cumulative') y = 140 - yScaleCases(d.cumulative_cases) - yScaleCases(dp);\n    if (options.timeline_type === 'non-cumulative') y = 140 - yScaleCases(d.new_cases) - yScaleCases(dp);\n    if (options.timeline_type === 'stacked') y = 140 - 140 * (d.new_cases / totalNewCases) - 140 * (dp / totalNewCases);\n\n    if (y) {\n      if (y > 0) {\n        return y;\n      } else {\n        return 0;\n      }\n\n      ;\n    } else {\n      return 0;\n    }\n\n    ;\n  }).attr('height', function (d, i) {\n    const totalNewCases = d3.select(this.parentNode).datum().total_new_cases - d3.select(this.parentNode).datum().OTH.new_cases;\n    let y = 0;\n    if (options.timeline_type === 'cumulative') y = yScaleCases(d.cumulative_cases);\n    if (options.timeline_type === 'non-cumulative') y = yScaleCases(d.new_cases);\n    if (options.timeline_type === 'stacked') y = 140 * (d.new_cases / totalNewCases);\n\n    if (y) {\n      if (y > 0) {\n        return y;\n      } else {\n        return 0;\n      }\n\n      ;\n    } else {\n      return 0;\n    }\n\n    ;\n  }).attr('fill', function (d, i) {\n    return colors.regions[d.region];\n    return 'blue';\n  }); // // DEATHS\n\n  barGroups.selectAll('.deaths_bar').data(function (d, i) {\n    return d.region.filter(function (dd, ii) {\n      return dd.region !== 'OTH';\n    });\n  }).transition().duration(500).attr('y', function (d, i) {\n    const totalNewDeaths = d3.select(this.parentNode).datum().total_new_deaths - d3.select(this.parentNode).datum().OTH.new_deaths;\n    let dp = 0;\n\n    if (i > 0) {\n      for (let ii = 1; ii <= i; ii++) {\n        if (options.timeline_type === 'cumulative') dp += d3.select(this.parentNode).datum().region[ii - 1].cumulative_deaths;\n        if (options.timeline_type === 'non-cumulative') dp += d3.select(this.parentNode).datum().region[ii - 1].new_deaths;\n        if (options.timeline_type === 'stacked') dp += d3.select(this.parentNode).datum().region[ii - 1].new_deaths;\n      }\n    }\n\n    let y = 0;\n    if (options.timeline_type === 'cumulative') y = 140 - yScaleDeaths(d.cumulative_deaths) - yScaleDeaths(dp) + 170;\n    if (options.timeline_type === 'non-cumulative') y = 140 - yScaleDeaths(d.new_deaths) - yScaleDeaths(dp) + 170;\n    if (options.timeline_type === 'stacked') y = 140 - 140 * (d.new_deaths / totalNewDeaths) - 140 * (dp / totalNewDeaths) + 170;\n\n    if (y) {\n      if (y > 0) {\n        return y;\n      } else {\n        return 0;\n      }\n\n      ;\n    } else {\n      return 0;\n    }\n\n    ;\n  }).attr('height', function (d, i) {\n    const totalNewDeaths = d3.select(this.parentNode).datum().total_new_deaths - d3.select(this.parentNode).datum().OTH.new_deaths;\n    let y = 0;\n    if (options.timeline_type === 'cumulative') y = yScaleDeaths(d.cumulative_deaths);\n    if (options.timeline_type === 'non-cumulative') y = yScaleDeaths(d.new_deaths);\n    if (options.timeline_type === 'stacked') y = 140 * (d.new_deaths / totalNewDeaths);\n\n    if (y) {\n      if (y > 0) {\n        return y;\n      } else {\n        return 0;\n      }\n\n      ;\n    } else {\n      return 0;\n    }\n\n    ;\n  });\n\n  if (groupedData.length == 0) {\n    d3.selectAll('.cases_bar').transition().duration(500).attr('y', 140).attr('height', 0);\n    d3.selectAll('.deaths_bar').transition().duration(500).attr('y', 140 + 170).attr('height', 0);\n  } // // VACCINES\n\n\n  const vbarGroups = svg.selectAll('.vbar_group').data(vgroupedData).attr('data-date', function (d) {\n    return d.date;\n  }).attr('transform', function (d, i) {\n    return 'translate(' + xScale(d.date) + ', 344)';\n  });\n  vbarGroups.selectAll('.vaccines_bar').data(function (d, i) {\n    return d.region.filter(function (dd, ii) {\n      return dd.region !== 'OTH';\n    });\n  }).transition().duration(500).attr('y', function (d, i) {\n    const totalNewVaccines = d3.select(this.parentNode).datum().total_new_vaccines - d3.select(this.parentNode).datum().OTH.new_vaccines;\n    let dp = 0;\n\n    if (i > 0) {\n      for (let ii = 1; ii <= i; ii++) {\n        if (options.timeline_type === 'cumulative') dp += d3.select(this.parentNode).datum().region[ii - 1].cumulative_vaccines;\n        if (options.timeline_type === 'non-cumulative') dp += d3.select(this.parentNode).datum().region[ii - 1].new_vaccines;\n        if (options.timeline_type === 'stacked') dp += d3.select(this.parentNode).datum().region[ii - 1].new_vaccines;\n      }\n    }\n\n    let y = 0;\n    if (options.timeline_type === 'cumulative') y = 140 - yScaleVaccines(d.cumulative_vaccines) - yScaleVaccines(dp);\n    if (options.timeline_type === 'non-cumulative') y = 140 - yScaleVaccines(d.new_vaccines) - yScaleVaccines(dp);\n    if (options.timeline_type === 'stacked') y = 140 - 140 * (d.new_vaccines / totalNewVaccines) - 140 * (dp / totalNewVaccines);\n\n    if (y) {\n      if (y > 0) {\n        return y;\n      } else {\n        return 0;\n      }\n\n      ;\n    } else {\n      return 0;\n    }\n\n    ;\n  }).attr('height', function (d, i) {\n    const totalNewVaccines = d3.select(this.parentNode).datum().total_new_vaccines - d3.select(this.parentNode).datum().OTH.new_vaccines;\n    let y = 0;\n    if (options.timeline_type === 'cumulative') y = yScaleVaccines(d.cumulative_vaccines);\n    if (options.timeline_type === 'non-cumulative') y = yScaleVaccines(d.new_vaccines);\n    if (options.timeline_type === 'stacked') y = 140 * (d.new_vaccines / totalNewVaccines);\n\n    if (y) {\n      if (y > 0) {\n        return y;\n      } else {\n        return 0;\n      }\n\n      ;\n    } else {\n      return 0;\n    }\n\n    ;\n  });\n\n  if (vgroupedData.length == 0) {\n    d3.selectAll('.vaccines_bar').transition().duration(500).attr('y', 140).attr('height', 0);\n  } // // bar size tweak for spacing\n  // if(options.timeline_frequency==='month'){\n  //     barGroups.selectAll(\".timeBar\")\n  //     .attr(\"width\", function(d) {\n  //         var date = d3.select(this.parentNode).datum().date;\n  //         var next = d3.timeMonth.offset(date, 1);\n  //         return (xScale(next)- xScale(date))*(1-barSpacing);\n  //       })\n  //     .attr(\"x\", function(d) {\n  //         var date = d3.select(this.parentNode).datum().date;\n  //         var next = d3.timeMonth.offset(date, 1);\n  //         return (xScale(next)- xScale(date))*(barSpacing/2);\n  //       })\n  //     }\n\n}\nexport default drawTimechart;","map":{"version":3,"sources":["/Users/matthewsmawfield/www/ifrc-covid-dataviz/src/Timechart.js"],"names":["d3","moment","colors","nFormatter","yScaleCases","yScaleDeaths","yScaleVaccines","yAxisCases","yAxisDeaths","yAxisVaccines","yScaleCasesAxis","yScaleDeathsAxis","yScaleVaccinesAxis","xScale","xAxis","xScaleAxis","regions","drawTimechart","data","options","groupedData","who_data","forEach","d","i","timeline_frequency","date","week_start","month_start","ifrc_region","new_cases","new_deaths","cumulative_cases","cumulative_deaths","dd","ii","hasOwnProperty","total_new_cases","AF","AP","AM","EU","ME","OTH","total_cumulative_cases","total_new_deaths","total_cumulative_deaths","region","push","vgroupedData","timeline_type","vaccines_data","vaccines_data_daily","new_vaccines","daily_vaccinations","cumulative_vaccines","total_new_vaccines","vaccines_data_cumulative","endOfWeekDate","endOf","startOf","unix","maxDate","maxDateUnix","endOfMonthDate","total_vaccinations","total_cumulative_vaccines","filter","el","numIntervals","max","maxCases","maxDeaths","maxVaccines","minDate","md","add","svg","select","selectAll","remove","append","attr","width","barWidth","barSpacing","scaleTime","range","domain","scaleLinear","axisBottom","scale","tickSize","tickPadding","axisRight","ticks","tickFormat","yAxisGroup","yAxisCasesText","call","yAxisDeathsText","yAxisVaccinesText","xAxisCases","xAxisDeaths","xAxisVaccines","xAxisTimeline","barGroups","enter","totalNewCases","parentNode","datum","dp","y","totalNewDeaths","next","timeMonth","offset","vbarGroups","totalNewVaccines","hoverBar","on","event","coords","pointer","xDate","invert","toDate","updateTimechart","length","transition","duration"],"mappings":"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","sourcesContent":["import * as d3 from \"d3\";\nimport moment from 'moment';\nimport colors from './colors';\nimport {nFormatter} from './HelperFunctions';\n\nlet yScaleCases;\nlet yScaleDeaths;\nlet yScaleVaccines;\nlet yAxisCases;\nlet yAxisDeaths;\nlet yAxisVaccines;\nlet yScaleCasesAxis;\nlet yScaleDeathsAxis;\nlet yScaleVaccinesAxis;\nlet xScale;\nlet xAxis; \nlet xScaleAxis;\n\nconst regions = ['AF', 'ME', 'AP', 'EU', 'AM', 'OTH'];\n\nexport function drawTimechart(data, options) {\n\n    const groupedData = [];\n\n    data.who_data.forEach(function(d,i){\n        if(!groupedData[d[options.timeline_frequency+'Total']])groupedData[d[options.timeline_frequency+'Total']] = {};\n        if(options.timeline_frequency==='day') groupedData[d[options.timeline_frequency+'Total']].date = d.date;\n        if(options.timeline_frequency==='week') groupedData[d[options.timeline_frequency+'Total']].date = d.week_start;\n        if(options.timeline_frequency==='month') groupedData[d[options.timeline_frequency+'Total']].date = d.month_start;\n        if(!groupedData[d[options.timeline_frequency+'Total']][d.ifrc_region]) groupedData[d[options.timeline_frequency+'Total']][d.ifrc_region] = {new_cases: 0, new_deaths: 0, cumulative_cases: 0, cumulative_deaths: 0};\n        groupedData[d[options.timeline_frequency+'Total']][d.ifrc_region].new_cases += d.new_cases;\n        groupedData[d[options.timeline_frequency+'Total']][d.ifrc_region].new_deaths += d.new_deaths;\n        groupedData[d[options.timeline_frequency+'Total']][d.ifrc_region].cumulative_cases = 0;\n    });\n\n    // totals by date\n    groupedData.forEach(function(d,i){\n        regions.forEach(function(dd,ii){\n            if(!d.hasOwnProperty(dd)){\n               d[dd] = {new_cases: 0, new_deaths: 0, cumulative_cases: 0, cumulative_deaths: 0};\n            }\n            // if(dd!=='OTH') d.region.push({'region': dd, 'new_cases': d[dd].new_cases, 'new_deaths': d[dd].new_deaths, 'cumulative_cases': d[dd].cumulative_cases, 'cumulative_deaths': d[dd].cumulative_deaths});\n            if(i>0){\n                d[dd].cumulative_cases = groupedData[i][dd].new_cases + groupedData[i-1][dd].cumulative_cases;\n                d[dd].cumulative_deaths = groupedData[i][dd].new_deaths + groupedData[i-1][dd].cumulative_deaths;\n            } else {\n                d[dd].cumulative_cases = groupedData[i][dd].new_cases;\n                d[dd].cumulative_deaths = groupedData[i][dd].new_deaths;\n            }\n        })\n\n        d.total_new_cases = d.AF.new_cases + d.AP.new_cases + d.AM.new_cases + d.EU.new_cases + d.ME.new_cases + d.OTH.new_cases; \n        d.total_cumulative_cases = d.AF.cumulative_cases + d.AP.cumulative_cases + d.AM.cumulative_cases + d.EU.cumulative_cases + d.ME.cumulative_cases + d.OTH.cumulative_cases; \n        d.total_new_deaths = d.AF.new_deaths + d.AP.new_deaths + d.AM.new_deaths + d.EU.new_deaths + d.ME.new_deaths + d.OTH.new_deaths; \n        d.total_cumulative_deaths = d.AF.cumulative_deaths + d.AP.cumulative_deaths + d.AM.cumulative_deaths + d.EU.cumulative_deaths + d.ME.cumulative_deaths + d.OTH.cumulative_deaths; \n        d.region = [];\n\n        regions.forEach(function(dd,ii){\n            d.region.push({'region': dd, 'new_cases': d[dd].new_cases, 'new_deaths': d[dd].new_deaths, 'cumulative_cases': d[dd].cumulative_cases, 'cumulative_deaths': d[dd].cumulative_deaths});\n        })\n\n    });\n\n    let vgroupedData = [];\n\n    if(options.timeline_type!='cumulative'){ // cumulative and stacked\n        data.vaccines_data = data.vaccines_data_daily;\n        data.vaccines_data.forEach(function(d,i){\n            if(!vgroupedData[d[options.timeline_frequency+'Total']])vgroupedData[d[options.timeline_frequency+'Total']] = {};\n            if(options.timeline_frequency==='day') vgroupedData[d[options.timeline_frequency+'Total']].date = d.date;\n            if(options.timeline_frequency==='week') vgroupedData[d[options.timeline_frequency+'Total']].date = d.week_start;\n            if(options.timeline_frequency==='month') vgroupedData[d[options.timeline_frequency+'Total']].date = d.month_start;\n            if(!vgroupedData[d[options.timeline_frequency+'Total']][d.ifrc_region]) vgroupedData[d[options.timeline_frequency+'Total']][d.ifrc_region] = {new_vaccines: 0};\n            vgroupedData[d[options.timeline_frequency+'Total']][d.ifrc_region].new_vaccines += d.daily_vaccinations;\n        });\n        // totals by date\n        vgroupedData.forEach(function(d,i){\n            regions.forEach(function(dd,ii){\n                if(!d[dd]){\n                    d[dd] = {new_vaccines: 0, cumulative_vaccines: 0}\n                }\n            });\n            d.total_new_vaccines = d.AF.new_vaccines + d.AP.new_vaccines + d.AM.new_vaccines + d.EU.new_vaccines + d.ME.new_vaccines + d.OTH.new_vaccines; \n            d.region = [];\n            regions.forEach(function(dd,ii){\n                d.region.push({'region': dd, 'new_vaccines': d[dd].new_vaccines});\n            })\n        });\n\n    } else{ // cumulative only\n        data.vaccines_data = [];\n        if(options.timeline_frequency==='day') {\n            data.vaccines_data = data.vaccines_data_cumulative;\n        }\n        if(options.timeline_frequency==='week') {\n            data.vaccines_data_cumulative.forEach(function(d,i){\n                var endOfWeekDate = moment(d.date).endOf('isoWeek').startOf('day').unix();\n                var date = moment(d.date).startOf('day').unix();\n                if((date==endOfWeekDate)||(d.date==options.maxDate)){\n                    data.vaccines_data.push(d);\n                }\n            })\n        }\n        if(options.timeline_frequency==='month') {\n            var maxDateUnix = moment(options.maxDate).startOf('day').unix();\n            data.vaccines_data_cumulative.forEach(function(d,i){\n                var endOfMonthDate = moment(d.date).endOf('month').startOf('day').unix();\n                var date = moment(d.date).startOf('day').unix();\n                if((date==endOfMonthDate)||((options.maxDate!=endOfMonthDate)&&(date==maxDateUnix))){\n                    data.vaccines_data.push(d);\n                }\n            })\n        }\n\n        data.vaccines_data.forEach(function(d,i){\n            if(!vgroupedData[d[options.timeline_frequency+'Total']])vgroupedData[d[options.timeline_frequency+'Total']] = {};\n            if(options.timeline_frequency==='day') vgroupedData[d[options.timeline_frequency+'Total']].date = d.date;\n            if(options.timeline_frequency==='week') vgroupedData[d[options.timeline_frequency+'Total']].date = d.week_start;\n            if(options.timeline_frequency==='month') vgroupedData[d[options.timeline_frequency+'Total']].date = d.month_start;\n            if(!vgroupedData[d[options.timeline_frequency+'Total']][d.ifrc_region]) vgroupedData[d[options.timeline_frequency+'Total']][d.ifrc_region] = {cumulative_vaccines: 0};\n            vgroupedData[d[options.timeline_frequency+'Total']][d.ifrc_region].cumulative_vaccines += d.total_vaccinations;\n        });\n        // totals by date\n        vgroupedData.forEach(function(d,i){\n            regions.forEach(function(dd,ii){\n                if(!d[dd]){\n                    d[dd] = {cumulative_vaccines: 0}\n                }\n            });\n            d.total_cumulative_vaccines = d.AF.cumulative_vaccines + d.AP.cumulative_vaccines + d.AM.cumulative_vaccines + d.EU.cumulative_vaccines + d.ME.cumulative_vaccines + d.OTH.cumulative_vaccines; \n            d.region = [];\n            regions.forEach(function(dd,ii){\n                d.region.push({'region': dd, 'cumulative_vaccines': d[dd].cumulative_vaccines});\n            })\n        });\n    }\n\n    vgroupedData = vgroupedData.filter(function(el) { return el; });\n\n    const numIntervals = d3.max(data.who_data, function(d,i){\n        return d[options.timeline_frequency+'Total'];\n    });\n\n    const maxCases = d3.max(groupedData, function(d,i){\n        if(options.timeline_type==='non-cumulative') return d.total_new_cases;\n        if(options.timeline_type==='cumulative') return d.total_cumulative_cases;\n        if(options.timeline_type==='stacked') return 100;\n    })\n\n    const maxDeaths = d3.max(groupedData, function(d,i){\n        if(options.timeline_type==='non-cumulative') return d.total_new_deaths;\n        if(options.timeline_type==='cumulative') return d.total_cumulative_deaths;\n        if(options.timeline_type==='stacked') return 100;\n    })\n\n    const maxVaccines = d3.max(vgroupedData, function(d,i){\n        if(d){\n            if(options.timeline_type==='non-cumulative') return d.total_new_vaccines;\n            if(options.timeline_type==='cumulative') return d.total_cumulative_vaccines;\n            if(options.timeline_type==='stacked') return 100;\n        }\n    })\n\n    // define date range\n    // const minDate = groupedData[0].date;\n    // const maxDate = groupedData[numIntervals].date;\n    const minDate = groupedData[0].date;\n    const maxDate = options.maxDate;\n    let md = moment(maxDate);\n\n    if(options.timeline_frequency==='month') md = md.add(1, 'months');\n    if(options.timeline_frequency==='week') md = md.add(1, 'weeks');\n    if(options.timeline_frequency==='day') md = md.add(1, 'days');\n\n    const svg = d3.select('#timechart_svg');\n    svg.selectAll('g').remove();\n    d3.selectAll('#layout .yAxis').remove();\n    d3.selectAll('#yAxis').remove();\n    d3.selectAll('#layout .xAxis').remove();\n\n    //bg\n    svg.append('g').append('rect')\n    .attr('width', '100%')\n    .attr('height', '100%')\n    .attr('x', 0)\n    .attr('y', 0)\n    .attr('fill', '#FFF')\n    .attr('opacity', 0);\n\n    const width = 2000;\n    const barWidth = width/numIntervals;\n\n    let barSpacing = 0.04; \n    if(options.timeline_frequency==='month') barSpacing = 0.03;\n    if(options.timeline_frequency==='day') barSpacing = 0;\n\n    // define scales\n\n    xScale = d3.scaleTime()\n    .range([0,width])\n    .domain([minDate,md]);\n\n    xScaleAxis = d3.scaleTime()\n    .range([0,596])\n    .domain([minDate,md]);\n\n    // xScaleAxis = d3.scaleTime()\n    // .range([35,596])\n    // .domain([minDate,maxDate]);\n\n    yScaleCases = d3.scaleLinear()\n    .range([0,140])\n    .domain([0,maxCases]);\n\n    yScaleCasesAxis = d3.scaleLinear()\n    .range([140,0])\n    .domain([0,maxCases]);\n\n    yScaleDeaths = d3.scaleLinear()\n    .range([0,140])\n    .domain([0,maxDeaths]);\n\n    yScaleDeathsAxis = d3.scaleLinear()\n    .range([140,0])\n    .domain([0,maxDeaths]);\n\n    yScaleVaccines = d3.scaleLinear()\n    .range([0,140])\n    .domain([0,maxVaccines]);\n\n    yScaleVaccinesAxis = d3.scaleLinear()\n    .range([140,0])\n    .domain([0,maxVaccines]);\n\n    // define axi\n    \n    xAxis = d3.axisBottom()\n    .scale(xScaleAxis)\n    .tickSize(2)\n    .tickPadding(3);\n\n    // if(options.timeline_frequency=='month')\n    // xAxis.ticks(d3.timeMonth.every(3)).tickFormat(d3.timeFormat(\"%b %Y\"));\n\n    // if(options.timeline_frequency=='week')\n    // xAxis.ticks(d3.timeWeek.every(10)).tickFormat(d3.timeFormat(\"%d %b %Y\"));\n\n    yAxisCases = d3.axisRight()\n    .scale(yScaleCasesAxis)\n    .ticks(3)\n    .tickSize(3)\n    .tickPadding(3)\n    .tickFormat(function(d){\n        if(options.timeline_type=='stacked') return nFormatter(d)+'%';\n        return nFormatter(d);\n    })\n\n    yAxisDeaths = d3.axisRight()\n    .scale(yScaleDeathsAxis)\n    .ticks(3)\n    .tickSize(3)\n    .tickPadding(3)\n    .tickFormat(function(d){\n        if(options.timeline_type=='stacked') return nFormatter(d)+'%';\n        return nFormatter(d);\n    })\n\n    yAxisVaccines = d3.axisRight()\n    .scale(yScaleVaccinesAxis)\n    .ticks(3)\n    .tickSize(3)\n    .tickPadding(3)\n    .tickFormat(function(d){\n        if(options.timeline_type=='stacked') return nFormatter(d)+'%';\n        return nFormatter(d);\n    })\n\n    // y-axis cases\n    var yAxisGroup = d3.select('#layout').append(\"g\").attr('id', 'yAxis').attr('clip-path', 'url(#mask)');\n\n    var yAxisCasesText = yAxisGroup.append(\"g\")\n    .attr(\"class\", \"yAxis axis\")\n    .attr(\"id\", \"casesAxis\")\n    .attr('transform', 'translate(620,363)')\n    .call(yAxisCases);\n\n    // y-axis deaths\n    var yAxisDeathsText = yAxisGroup.append(\"g\")\n    .attr(\"class\", \"yAxis axis\")\n    .attr(\"id\", \"deathsAxis\")\n    .attr('transform', 'translate(620,534)')\n    .call(yAxisDeaths);\n\n    // y-axis vaccines\n    var yAxisVaccinesText = yAxisGroup.append(\"g\")\n    .attr(\"class\", \"yAxis axis\")\n    .attr(\"id\", \"VaccinesAxis\")\n    .attr('transform', 'translate(620,707.5)')\n    .call(yAxisVaccines);\n\n    // x-axis cases\n    var xAxisCases = yAxisGroup.append('g')\n    .attr(\"id\", \"casesXAxis\")\n    .attr('class', 'xAxis')\n    .attr('transform', 'translate(24,504)')\n    .call(xAxis);\n\n    var xAxisDeaths = yAxisGroup.append('g')\n    .attr(\"id\", \"deathsXAxis\")\n    .attr('class', 'xAxis')\n    .attr('transform', 'translate(24,674)')\n    .call(xAxis);\n\n    var xAxisVaccines = yAxisGroup.append('g')\n    .attr(\"id\", \"vaccinesXAxis\")\n    .attr('class', 'xAxis')\n    .attr('transform', 'translate(24,848)')\n    .call(xAxis);\n\n    var xAxisTimeline = yAxisGroup.append('g')\n    .attr(\"id\", \"timelineXAxis\")\n    .attr('class', 'xAxis')\n    .attr('transform', 'translate(24,908)')\n    .call(xAxis);\n\n    // CASES\n    // loop through groupedData and draw bars\n    const barGroups = svg.selectAll('.bar_group')\n    .data(groupedData)\n    .enter()\n    .append('g')\n    .attr('class', 'bar_group')\n    .attr('data-date', function(d){ return d.date})\n    .attr('transform', function(d,i){ \n        return 'translate('+xScale(d.date)+')'\n    })\n\n    // CASES\n    barGroups.selectAll('.cases_bar')\n    .data(function(d,i){ return d.region.filter(function(dd,ii){\n        return dd.region!=='OTH';\n    })})\n    .enter()\n    .append('rect')\n    .attr('class', function(d,i) { return 'timeBar cases_bar time_'+d.region })\n    .attr('x', (barWidth*barSpacing))\n    .attr('y', function(d,i){\n        const totalNewCases = d3.select(this.parentNode).datum().total_new_cases - d3.select(this.parentNode).datum().OTH.new_cases;\n        let dp = 0;\n        if(i>0){\n            for(let ii=1;ii<=i;ii++){\n                if(options.timeline_type==='cumulative') dp += d3.select(this.parentNode).datum().region[ii-1].cumulative_cases;\n                if(options.timeline_type==='non-cumulative') dp += d3.select(this.parentNode).datum().region[ii-1].new_cases;\n                if(options.timeline_type==='stacked') dp += d3.select(this.parentNode).datum().region[ii-1].new_cases;\n            }\n        }\n        let y = 0;\n        if(options.timeline_type==='cumulative') y = (140-yScaleCases(d.cumulative_cases)-(yScaleCases(dp)))\n        if(options.timeline_type==='non-cumulative') y = (140-yScaleCases(d.new_cases)-(yScaleCases(dp)))\n        if(options.timeline_type==='stacked') y = (140-(140*(d.new_cases/totalNewCases))-((140*(dp/totalNewCases))))\n        if(y){ if(y>0) { return y} else { return 0}; } else { return 0};\n    })\n    .attr('width', barWidth-(barWidth*barSpacing*2))\n    .attr('height', function(d,i){\n        const totalNewCases = d3.select(this.parentNode).datum().total_new_cases - d3.select(this.parentNode).datum().OTH.new_cases;\n        let y = 0;\n        if(options.timeline_type==='cumulative') y = yScaleCases(d.cumulative_cases);\n        if(options.timeline_type==='non-cumulative') y = yScaleCases(d.new_cases);\n        if(options.timeline_type==='stacked') y = (140*(d.new_cases/totalNewCases));\n        if(y){ if(y>0) { return y} else { return 0}; } else { return 0};\n    })\n    .attr('fill', function(d,i){\n        return colors.regions[d.region];\n    })\n\n    // DEATHS\n    barGroups.selectAll('.deaths_bar')\n    .data(function(d,i){ return d.region.filter(function(dd,ii){\n        return dd.region!=='OTH';\n    })})\n    .enter()\n    .append('rect')\n    .attr('class', function(d,i) { return 'timeBar deaths_bar time_'+d.region })\n    .attr('x', (barWidth*barSpacing))\n    .attr('y', function(d,i){\n        const totalNewDeaths = d3.select(this.parentNode).datum().total_new_deaths - d3.select(this.parentNode).datum().OTH.new_deaths;\n        let dp = 0;\n        if(i>0){\n            for(let ii=1;ii<=i;ii++){\n                if(options.timeline_type==='cumulative') dp += d3.select(this.parentNode).datum().region[ii-1].cumulative_deaths;\n                if(options.timeline_type==='non-cumulative') dp += d3.select(this.parentNode).datum().region[ii-1].new_deaths;\n                if(options.timeline_type==='stacked') dp += d3.select(this.parentNode).datum().region[ii-1].new_deaths;\n            }\n        }\n        let y = 0;\n        if(options.timeline_type==='cumulative') y = (140-yScaleDeaths(d.cumulative_deaths)-(yScaleDeaths(dp))+170)\n        if(options.timeline_type==='non-cumulative') y = (140-yScaleDeaths(d.new_deaths)-(yScaleDeaths(dp))+170)\n        if(options.timeline_type==='stacked') y = (140-(140*(d.new_deaths/totalNewDeaths))-((140*(dp/totalNewDeaths)))+170)\n        if(y){ if(y>0) { return y} else { return 0}; } else { return 0};\n    })\n    .attr('width', barWidth-(barWidth*barSpacing*2))\n    .attr('height', function(d,i){\n        const totalNewDeaths = d3.select(this.parentNode).datum().total_new_deaths - d3.select(this.parentNode).datum().OTH.new_deaths;\n        let y = 0;\n        if(options.timeline_type==='cumulative') y = yScaleDeaths(d.cumulative_deaths);\n        if(options.timeline_type==='non-cumulative') y = yScaleDeaths(d.new_deaths);\n        if(options.timeline_type==='stacked') y = (140*(d.new_deaths/totalNewDeaths));\n        if(y){ if(y>0) { return y} else { return 0}; } else { return 0};\n    })\n    .attr('fill', function(d,i){\n        return colors.regions[d.region];\n    });\n\n    // bar size tweak for spacing\n    if(options.timeline_frequency==='month'){\n        barGroups.selectAll(\".timeBar\")\n        .attr(\"width\", function(d) {\n            var date = d3.select(this.parentNode).datum().date;\n            var next = d3.timeMonth.offset(date, 1);\n            return (xScale(next)- xScale(date))*(1-barSpacing);\n            })\n        .attr(\"x\", function(d) {\n            var date = d3.select(this.parentNode).datum().date;\n            var next = d3.timeMonth.offset(date, 1);\n            return (xScale(next)- xScale(date))*(barSpacing/2);\n            })\n        }\n\n    // VACCINES\n\n    const vbarGroups = svg.selectAll('.vbar_group')\n    .data(vgroupedData)\n    .enter()\n    .append('g')\n    .attr('class', 'vbar_group')\n    .attr('data-date', function(d){ return d.date})\n    .attr('transform', function(d,i){ \n        return 'translate('+xScale(d.date)+', 344)'\n    })\n   \n    vbarGroups.selectAll('.vaccines_bar')\n    .data(function(d,i){ return d.region.filter(function(dd,ii){\n        return dd.region!=='OTH';\n    })})\n    .enter()\n    .append('rect')\n    .attr('class', 'timeBar vaccines_bar')\n    .attr('class', function(d,i) { return 'timeBar vaccines_bar time_'+d.region })\n    .attr('x', (barWidth*barSpacing))\n    .attr('y', function(d,i){\n        const totalNewVaccines = d3.select(this.parentNode).datum().total_new_vaccines - d3.select(this.parentNode).datum().OTH.new_vaccines;\n        let dp = 0;\n        if(i>0){\n            for(let ii=1;ii<=i;ii++){\n                if(options.timeline_type==='cumulative') dp += d3.select(this.parentNode).datum().region[ii-1].cumulative_vaccines;\n                if(options.timeline_type==='non-cumulative') dp += d3.select(this.parentNode).datum().region[ii-1].new_vaccines;\n                if(options.timeline_type==='stacked') dp += d3.select(this.parentNode).datum().region[ii-1].new_vaccines;\n            }\n        }\n        let y = 0;\n        if(options.timeline_type==='cumulative') y = (140-yScaleVaccines(d.cumulative_vaccines)-(yScaleVaccines(dp)))\n        if(options.timeline_type==='non-cumulative') y = (140-yScaleVaccines(d.new_vaccines)-(yScaleVaccines(dp)))\n        if(options.timeline_type==='stacked') y = (140-(140*(d.new_vaccines/totalNewVaccines))-((140*(dp/totalNewVaccines))))\n        if(y){ if(y>0) { return y} else { return 0}; } else { return 0};\n    })\n    .attr('width', barWidth-(barWidth*barSpacing*2))\n    .attr('height', function(d,i){\n        const totalNewVaccines = d3.select(this.parentNode).datum().total_new_vaccines - d3.select(this.parentNode).datum().OTH.new_vaccines;\n        let y = 0;\n        if(options.timeline_type==='cumulative') y = yScaleVaccines(d.cumulative_vaccines);\n        if(options.timeline_type==='non-cumulative') y = yScaleVaccines(d.new_vaccines);\n        if(options.timeline_type==='stacked') y = (140*(d.new_vaccines/totalNewVaccines));\n        if(y){ if(y>0) { return y} else { return 0}; } else { return 0};\n    })\n    .attr('fill', function(d,i){\n        return colors.regions[d.region];\n    });\n\n    if(options.timeline_frequency==='month'){\n    vbarGroups.selectAll(\".timeBar\")\n    .attr(\"width\", function(d) {\n        var date = d3.select(this.parentNode).datum().date;\n        var next = d3.timeMonth.offset(date, 1);\n        return (xScale(next)- xScale(date))*(1-barSpacing);\n        })\n    .attr(\"x\", function(d) {\n        var date = d3.select(this.parentNode).datum().date;\n        var next = d3.timeMonth.offset(date, 1);\n        return (xScale(next)- xScale(date))*(barSpacing/2);\n        })\n    }\n\n    // bar size tweak for spacing\n    if(options.timeline_frequency==='month'){\n        barGroups.selectAll(\".timeBar\")\n        .attr(\"width\", function(d) {\n            var date = d3.select(this.parentNode).datum().date;\n            var next = d3.timeMonth.offset(date, 1);\n            return (xScale(next)- xScale(date))*(1-barSpacing);\n          })\n        .attr(\"x\", function(d) {\n            var date = d3.select(this.parentNode).datum().date;\n            var next = d3.timeMonth.offset(date, 1);\n            return (xScale(next)- xScale(date))*(barSpacing/2);\n          })\n        }\n\n        // hover bar\n        var hoverBar = svg.append('rect')\n        .attr('id','timechart_hover')\n        .attr('width', barWidth)\n        .attr('x', 0)\n        .attr('y', 0)\n        .attr('opacity', 0)\n        .attr('height', '100%')\n        .attr('fill', 'rgb(221 221 221 / 40%)')\n\n        svg.on('mouseover', function(d,i){\n            hoverBar.attr('opacity', 1)\n        }).on('mouseout', function(d,i){\n            hoverBar.attr('opacity', 0)\n        }).on('mousemove', (event) => {\n            var coords = d3.pointer( event );\n            var xDate = xScale.invert(coords[0]);\n            if(options.timeline_frequency=='week') xDate = moment(xDate).startOf('isoWeek');\n            if(options.timeline_frequency=='day') xDate = moment(xDate).startOf('day');\n            if(options.timeline_frequency=='month') xDate = moment(xDate).startOf('month');\n            hoverBar.attr('x', xScale(xDate.toDate()));\n            if(xScale(xDate.toDate()>options.maxDate)){\n                hoverBar.attr('opacity', 0);\n            } else {\n                hoverBar.attr('opacity', 1);\n            }\n        });\n\n\n}\n\nexport function updateTimechart(data, options) {\n\n    const groupedData = [];\n\n    data.who_data.forEach(function(d,i){\n        if(!groupedData[d[options.timeline_frequency+'Total']])groupedData[d[options.timeline_frequency+'Total']] = {};\n        if(options.timeline_frequency==='day') groupedData[d[options.timeline_frequency+'Total']].date = d.date;\n        if(options.timeline_frequency==='week') groupedData[d[options.timeline_frequency+'Total']].date = d.week_start;\n        if(options.timeline_frequency==='month') groupedData[d[options.timeline_frequency+'Total']].date = d.month_start;\n        if(!groupedData[d[options.timeline_frequency+'Total']][d.ifrc_region]) groupedData[d[options.timeline_frequency+'Total']][d.ifrc_region] = {new_cases: 0, new_deaths: 0, cumulative_cases: 0, cumulative_deaths: 0};\n        groupedData[d[options.timeline_frequency+'Total']][d.ifrc_region].new_cases += d.new_cases;\n        groupedData[d[options.timeline_frequency+'Total']][d.ifrc_region].new_deaths += d.new_deaths;\n        groupedData[d[options.timeline_frequency+'Total']][d.ifrc_region].cumulative_cases = 0;\n    });\n\n    // totals by date\n    groupedData.forEach(function(d,i){\n        regions.forEach(function(dd,ii){\n            if(!d.hasOwnProperty(dd)){\n               d[dd] = {new_cases: 0, new_deaths: 0, cumulative_cases: 0, cumulative_deaths: 0};\n            }\n            // if(dd!=='OTH') d.region.push({'region': dd, 'new_cases': d[dd].new_cases, 'new_deaths': d[dd].new_deaths, 'cumulative_cases': d[dd].cumulative_cases, 'cumulative_deaths': d[dd].cumulative_deaths});\n            if(i>0){\n                d[dd].cumulative_cases = groupedData[i][dd].new_cases + groupedData[i-1][dd].cumulative_cases;\n                d[dd].cumulative_deaths = groupedData[i][dd].new_deaths + groupedData[i-1][dd].cumulative_deaths;\n            } else {\n                d[dd].cumulative_cases = groupedData[i][dd].new_cases;\n                d[dd].cumulative_deaths = groupedData[i][dd].new_deaths;\n            }\n        })\n\n        d.total_new_cases = d.AF.new_cases + d.AP.new_cases + d.AM.new_cases + d.EU.new_cases + d.ME.new_cases + d.OTH.new_cases; \n        d.total_cumulative_cases = d.AF.cumulative_cases + d.AP.cumulative_cases + d.AM.cumulative_cases + d.EU.cumulative_cases + d.ME.cumulative_cases + d.OTH.cumulative_cases; \n        d.total_new_deaths = d.AF.new_deaths + d.AP.new_deaths + d.AM.new_deaths + d.EU.new_deaths + d.ME.new_deaths + d.OTH.new_deaths; \n        d.total_cumulative_deaths = d.AF.cumulative_deaths + d.AP.cumulative_deaths + d.AM.cumulative_deaths + d.EU.cumulative_deaths + d.ME.cumulative_deaths + d.OTH.cumulative_deaths; \n        d.region = [];\n\n        regions.forEach(function(dd,ii){\n            d.region.push({'region': dd, 'new_cases': d[dd].new_cases, 'new_deaths': d[dd].new_deaths, 'cumulative_cases': d[dd].cumulative_cases, 'cumulative_deaths': d[dd].cumulative_deaths});\n        })\n\n    });\n\n    let vgroupedData = [];\n\n    if(options.timeline_type!='cumulative'){ // cumulative and stacked\n        data.vaccines_data = data.vaccines_data_daily;\n        data.vaccines_data.forEach(function(d,i){\n            if(!vgroupedData[d[options.timeline_frequency+'Total']])vgroupedData[d[options.timeline_frequency+'Total']] = {};\n            if(options.timeline_frequency==='day') vgroupedData[d[options.timeline_frequency+'Total']].date = d.date;\n            if(options.timeline_frequency==='week') vgroupedData[d[options.timeline_frequency+'Total']].date = moment(d.date).startOf('isoWeek').toDate();\n            if(options.timeline_frequency==='month') vgroupedData[d[options.timeline_frequency+'Total']].date = moment(d.date).startOf('month').toDate();\n            if(!vgroupedData[d[options.timeline_frequency+'Total']][d.ifrc_region]) vgroupedData[d[options.timeline_frequency+'Total']][d.ifrc_region] = {new_vaccines: 0};\n            vgroupedData[d[options.timeline_frequency+'Total']][d.ifrc_region].new_vaccines += d.daily_vaccinations;\n        });\n        // totals by date\n        vgroupedData.forEach(function(d,i){\n            regions.forEach(function(dd,ii){\n                if(!d[dd]){\n                    d[dd] = {new_vaccines: 0, cumulative_vaccines: 0}\n                }\n            });\n            d.total_new_vaccines = d.AF.new_vaccines + d.AP.new_vaccines + d.AM.new_vaccines + d.EU.new_vaccines + d.ME.new_vaccines + d.OTH.new_vaccines; \n            d.region = [];\n            regions.forEach(function(dd,ii){\n                d.region.push({'region': dd, 'new_vaccines': d[dd].new_vaccines});\n            })\n        });\n\n    } else{ // cumulative only\n        data.vaccines_data = [];\n        if(options.timeline_frequency==='day') {\n            data.vaccines_data = data.vaccines_data_cumulative;\n        }\n        if(options.timeline_frequency==='week') {\n            data.vaccines_data_cumulative.forEach(function(d,i){\n                var endOfWeekDate = moment(d.date).endOf('isoWeek').startOf('day').unix();\n                var date = moment(d.date).startOf('day').unix();\n                if((date==endOfWeekDate)||(d.date==options.maxDate)){\n                    data.vaccines_data.push(d);\n                }\n            })\n        }\n        if(options.timeline_frequency==='month') {\n            var maxDateUnix = moment(options.maxDate).startOf('day').unix();\n            data.vaccines_data_cumulative.forEach(function(d,i){\n                var endOfMonthDate = moment(d.date).endOf('month').startOf('day').unix();\n                var date = moment(d.date).startOf('day').unix();\n                if((date==endOfMonthDate)||((options.maxDate!=endOfMonthDate)&&(date==maxDateUnix))){\n                    data.vaccines_data.push(d);\n                }\n            })\n        }\n\n        data.vaccines_data.forEach(function(d,i){\n            if(!vgroupedData[d[options.timeline_frequency+'Total']])vgroupedData[d[options.timeline_frequency+'Total']] = {};\n            if(options.timeline_frequency==='day') vgroupedData[d[options.timeline_frequency+'Total']].date = d.date;\n            if(options.timeline_frequency==='week') vgroupedData[d[options.timeline_frequency+'Total']].date = moment(d.date).startOf('isoWeek').toDate();\n            if(options.timeline_frequency==='month') vgroupedData[d[options.timeline_frequency+'Total']].date = moment(d.date).startOf('month').toDate();\n            if(!vgroupedData[d[options.timeline_frequency+'Total']][d.ifrc_region]) vgroupedData[d[options.timeline_frequency+'Total']][d.ifrc_region] = {cumulative_vaccines: 0};\n            vgroupedData[d[options.timeline_frequency+'Total']][d.ifrc_region].cumulative_vaccines += d.total_vaccinations;\n        });\n        // totals by date\n        vgroupedData.forEach(function(d,i){\n            regions.forEach(function(dd,ii){\n                if(!d[dd]){\n                    d[dd] = {cumulative_vaccines: 0}\n                }\n            });\n            d.total_cumulative_vaccines = d.AF.cumulative_vaccines + d.AP.cumulative_vaccines + d.AM.cumulative_vaccines + d.EU.cumulative_vaccines + d.ME.cumulative_vaccines + d.OTH.cumulative_vaccines; \n            d.region = [];\n            regions.forEach(function(dd,ii){\n                d.region.push({'region': dd, 'cumulative_vaccines': d[dd].cumulative_vaccines});\n            })\n        });\n    }\n\n    vgroupedData = vgroupedData.filter(function(el) { return el; });\n\n    const numIntervals = d3.max(data.who_data, function(d,i){\n        return d[options.timeline_frequency+'Total'];\n    });\n\n    const maxCases = d3.max(groupedData, function(d,i){\n        if(options.timeline_type==='non-cumulative') return d.total_new_cases;\n        if(options.timeline_type==='cumulative') return d.total_cumulative_cases;\n        if(options.timeline_type==='stacked') return 100;\n    })\n\n    const maxDeaths = d3.max(groupedData, function(d,i){\n        if(options.timeline_type==='non-cumulative') return d.total_new_deaths;\n        if(options.timeline_type==='cumulative') return d.total_cumulative_deaths;\n        if(options.timeline_type==='stacked') return 100;\n    })\n\n    const maxVaccines = d3.max(vgroupedData, function(d,i){\n        if(d){\n            if(options.timeline_type==='non-cumulative') return d.total_new_vaccines;\n            if(options.timeline_type==='cumulative') return d.total_cumulative_vaccines;\n            if(options.timeline_type==='stacked') return 100;\n        }\n    })\n\n    // define date range\n    // const minDate = groupedData[0].date;\n    // const maxDate = groupedData[numIntervals].date;\n    let minDate;\n    if(groupedData.length>0){\n        minDate = groupedData[0].date;\n    } else {\n        minDate = options.minDate;\n    }\n\n    const maxDate = options.maxDate;\n    let md = moment(maxDate);\n\n    if(options.timeline_frequency==='month') md = md.add(1, 'months');\n    if(options.timeline_frequency==='week') md = md.add(1, 'weeks');\n    if(options.timeline_frequency==='day') md = md.add(1, 'days');\n\n    const svg = d3.select('#timechart_svg');\n\n    const width = 2000;\n    const barWidth = width/numIntervals;\n\n    let barSpacing = 0.04; \n    if(options.timeline_frequency==='month') barSpacing = 0.03;\n    if(options.timeline_frequency==='day') barSpacing = 0;\n\n    // define scales\n\n    xScale = d3.scaleTime()\n    .range([0,width])\n    .domain([minDate,md]);\n\n    xScaleAxis = d3.scaleTime()\n    .range([23,596])\n    .domain([minDate,md]);\n\n    yScaleCases = d3.scaleLinear()\n    .range([0,140])\n    .domain([0,maxCases]);\n\n    yScaleCasesAxis = d3.scaleLinear()\n    .range([140,0])\n    .domain([0,maxCases]);\n\n    yScaleDeaths = d3.scaleLinear()\n    .range([0,140])\n    .domain([0,maxDeaths]);\n\n    yScaleDeathsAxis = d3.scaleLinear()\n    .range([140,0])\n    .domain([0,maxDeaths]);\n\n    yScaleVaccines = d3.scaleLinear()\n    .range([0,140])\n    .domain([0,maxVaccines]);\n\n    yScaleVaccinesAxis = d3.scaleLinear()\n    .range([140,0])\n    .domain([0,maxVaccines]);\n\n    // define axi\n    \n    yAxisCases = d3.axisRight()\n    .scale(yScaleCasesAxis)\n    .ticks(3)\n    .tickSize(3)\n    .tickPadding(3)\n    .tickFormat(function(d){\n        if(options.timeline_type=='stacked') return nFormatter(d)+'%';\n        return nFormatter(d);\n    })\n\n    yAxisDeaths = d3.axisRight()\n    .scale(yScaleDeathsAxis)\n    .ticks(3)\n    .tickSize(3)\n    .tickPadding(3)\n    .tickFormat(function(d){\n        if(options.timeline_type=='stacked') return nFormatter(d)+'%';\n        return nFormatter(d);\n    })\n\n    yAxisVaccines = d3.axisRight()\n    .scale(yScaleVaccinesAxis)\n    .ticks(3)\n    .tickSize(3)\n    .tickPadding(3)\n    .tickFormat(function(d){\n        if(options.timeline_type=='stacked') return nFormatter(d)+'%';\n        return nFormatter(d);\n    })\n\n    // y-axis cases\n    var yAxisCasesText = d3.select('#casesAxis')\n    .transition()\n    .duration(500)\n    .call(yAxisCases);\n\n    // y-axis deaths\n    var yAxisDeathsText = d3.select('#deathsAxis')\n    .transition()\n    .duration(500)\n    .call(yAxisDeaths);\n\n    // y-axis vaccines\n    var yAxisVaccinesText = d3.select('#VaccinesAxis')\n    .transition()\n    .duration(500)\n    .call(yAxisVaccines);\n\n    // CASES\n    // loop through groupedData and draw bars\n    const barGroups = svg.selectAll('.bar_group')\n    .data(groupedData)\n    .attr('data-date', function(d){ return d.date})\n    .attr('transform', function(d,i){ \n        return 'translate('+xScale(d.date)+')'\n    })\n\n    // CASES\n    barGroups.selectAll('.cases_bar')\n    .data(function(d,i){ return d.region.filter(function(dd,ii){\n        return dd.region!=='OTH';\n    })})\n    .transition()\n    .duration(500)\n    .attr('y', function(d,i){\n        const totalNewCases = d3.select(this.parentNode).datum().total_new_cases - d3.select(this.parentNode).datum().OTH.new_cases;\n        let dp = 0;\n        if(i>0){\n            for(let ii=1;ii<=i;ii++){\n                if(options.timeline_type==='cumulative') dp += d3.select(this.parentNode).datum().region[ii-1].cumulative_cases;\n                if(options.timeline_type==='non-cumulative') dp += d3.select(this.parentNode).datum().region[ii-1].new_cases;\n                if(options.timeline_type==='stacked') dp += d3.select(this.parentNode).datum().region[ii-1].new_cases;\n            }\n        }\n        let y = 0;\n        if(options.timeline_type==='cumulative') y = (140-yScaleCases(d.cumulative_cases)-(yScaleCases(dp)))\n        if(options.timeline_type==='non-cumulative') y = (140-yScaleCases(d.new_cases)-(yScaleCases(dp)))\n        if(options.timeline_type==='stacked') y = (140-(140*(d.new_cases/totalNewCases))-((140*(dp/totalNewCases))))\n        if(y){ if(y>0) { return y} else { return 0}; } else { return 0};\n    })\n    .attr('height', function(d,i){\n        const totalNewCases = d3.select(this.parentNode).datum().total_new_cases - d3.select(this.parentNode).datum().OTH.new_cases;\n        let y = 0;\n        if(options.timeline_type==='cumulative') y = yScaleCases(d.cumulative_cases);\n        if(options.timeline_type==='non-cumulative') y = yScaleCases(d.new_cases);\n        if(options.timeline_type==='stacked') y = (140*(d.new_cases/totalNewCases));\n        if(y){ if(y>0) { return y} else { return 0}; } else { return 0};\n    })\n    .attr('fill', function(d,i){\n        return colors.regions[d.region];\n        return 'blue'\n    })\n\n    // // DEATHS\n    barGroups.selectAll('.deaths_bar')\n    .data(function(d,i){ return d.region.filter(function(dd,ii){\n        return dd.region!=='OTH';\n    })})\n    .transition()\n    .duration(500)\n    .attr('y', function(d,i){\n        const totalNewDeaths = d3.select(this.parentNode).datum().total_new_deaths - d3.select(this.parentNode).datum().OTH.new_deaths;\n        let dp = 0;\n        if(i>0){\n            for(let ii=1;ii<=i;ii++){\n                if(options.timeline_type==='cumulative') dp += d3.select(this.parentNode).datum().region[ii-1].cumulative_deaths;\n                if(options.timeline_type==='non-cumulative') dp += d3.select(this.parentNode).datum().region[ii-1].new_deaths;\n                if(options.timeline_type==='stacked') dp += d3.select(this.parentNode).datum().region[ii-1].new_deaths;\n            }\n        }\n        let y = 0;\n        if(options.timeline_type==='cumulative') y = (140-yScaleDeaths(d.cumulative_deaths)-(yScaleDeaths(dp))+170)\n        if(options.timeline_type==='non-cumulative') y = (140-yScaleDeaths(d.new_deaths)-(yScaleDeaths(dp))+170)\n        if(options.timeline_type==='stacked') y = (140-(140*(d.new_deaths/totalNewDeaths))-((140*(dp/totalNewDeaths)))+170)\n        if(y){ if(y>0) { return y} else { return 0}; } else { return 0};\n    })\n    .attr('height', function(d,i){\n        const totalNewDeaths = d3.select(this.parentNode).datum().total_new_deaths - d3.select(this.parentNode).datum().OTH.new_deaths;\n        let y = 0;\n        if(options.timeline_type==='cumulative') y = yScaleDeaths(d.cumulative_deaths);\n        if(options.timeline_type==='non-cumulative') y = yScaleDeaths(d.new_deaths);\n        if(options.timeline_type==='stacked') y = (140*(d.new_deaths/totalNewDeaths));\n        if(y){ if(y>0) { return y} else { return 0}; } else { return 0};\n    })\n\n    if(groupedData.length==0){\n        d3.selectAll('.cases_bar')\n        .transition()\n        .duration(500)\n        .attr('y', 140)\n        .attr('height', 0)\n\n        d3.selectAll('.deaths_bar')\n        .transition()\n        .duration(500)\n        .attr('y', 140+170)\n        .attr('height', 0)\n        \n    }\n    // // VACCINES\n\n    const vbarGroups = svg.selectAll('.vbar_group')\n    .data(vgroupedData)\n    .attr('data-date', function(d){ return d.date})\n    .attr('transform', function(d,i){ \n        return 'translate('+xScale(d.date)+', 344)'\n    })\n\n    vbarGroups.selectAll('.vaccines_bar')\n    .data(function(d,i){ return d.region.filter(function(dd,ii){\n        return dd.region!=='OTH';\n    })})\n    .transition()\n    .duration(500)\n    .attr('y', function(d,i){\n        const totalNewVaccines = d3.select(this.parentNode).datum().total_new_vaccines - d3.select(this.parentNode).datum().OTH.new_vaccines;\n        let dp = 0;\n        if(i>0){\n            for(let ii=1;ii<=i;ii++){\n                if(options.timeline_type==='cumulative') dp += d3.select(this.parentNode).datum().region[ii-1].cumulative_vaccines;\n                if(options.timeline_type==='non-cumulative') dp += d3.select(this.parentNode).datum().region[ii-1].new_vaccines;\n                if(options.timeline_type==='stacked') dp += d3.select(this.parentNode).datum().region[ii-1].new_vaccines;\n            }\n        }\n        let y = 0;\n        if(options.timeline_type==='cumulative') y = (140-yScaleVaccines(d.cumulative_vaccines)-(yScaleVaccines(dp)))\n        if(options.timeline_type==='non-cumulative') y = (140-yScaleVaccines(d.new_vaccines)-(yScaleVaccines(dp)))\n        if(options.timeline_type==='stacked') y = (140-(140*(d.new_vaccines/totalNewVaccines))-((140*(dp/totalNewVaccines))))\n        if(y){ if(y>0) { return y} else { return 0}; } else { return 0};\n    })\n    .attr('height', function(d,i){\n        const totalNewVaccines = d3.select(this.parentNode).datum().total_new_vaccines - d3.select(this.parentNode).datum().OTH.new_vaccines;\n        let y = 0;\n        if(options.timeline_type==='cumulative') y = yScaleVaccines(d.cumulative_vaccines);\n        if(options.timeline_type==='non-cumulative') y = yScaleVaccines(d.new_vaccines);\n        if(options.timeline_type==='stacked') y = (140*(d.new_vaccines/totalNewVaccines));\n        if(y){ if(y>0) { return y} else { return 0}; } else { return 0};\n    });\n\n    if(vgroupedData.length==0){\n        d3.selectAll('.vaccines_bar')\n        .transition()\n        .duration(500)\n        .attr('y', 140)\n        .attr('height', 0)\n    }\n   \n    // // bar size tweak for spacing\n    // if(options.timeline_frequency==='month'){\n    //     barGroups.selectAll(\".timeBar\")\n    //     .attr(\"width\", function(d) {\n    //         var date = d3.select(this.parentNode).datum().date;\n    //         var next = d3.timeMonth.offset(date, 1);\n    //         return (xScale(next)- xScale(date))*(1-barSpacing);\n    //       })\n    //     .attr(\"x\", function(d) {\n    //         var date = d3.select(this.parentNode).datum().date;\n    //         var next = d3.timeMonth.offset(date, 1);\n    //         return (xScale(next)- xScale(date))*(barSpacing/2);\n    //       })\n    //     }\n\n}\n\nexport default drawTimechart;\n"]},"metadata":{},"sourceType":"module"}